"use strict";angular.module("gameApp",["ngCookies","ngResource","ngSanitize","gameApp.services.db","gameApp.services.session","gameApp.services.notification","gameApp.services.game","gameApp.services.mainplayer"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/game",{templateUrl:"views/game.html",controller:"GameCtrl"}).when("/users",{templateUrl:"views/users.html",controller:"UsersCtrl"}).when("/about",{templateUrl:"views/about.html"}).otherwise({redirectTo:"/"})}]),Date.prototype.getWeek=function(){var a=new Date(this.getFullYear(),0,1);return Math.ceil(((this-a)/864e5+a.getDay()+1)/7)},angular.module("gameApp").controller("MainCtrl",["$rootScope","$scope","$location","$timeout","Db","Session","Notification","Game",function(a,b,c,d,e,f,g,h){function i(){a.isSignedIn=f.isSignedIn();var c=f.getUser();c&&(b.name=c.name)}function j(a){var c=$.map(b.chat_messages,function(b,c){return b.id==a?c:void 0});return c[0]}a.current_date=(new Date).getTime(),a.weekNumber=(new Date).getWeek(),b.chat_messages=[],g.enable(),console.log("main"),h.stop(),i(),f.onUsersLoad(i),e.onChatMsg(function(a){b.chat_messages.push(a),h.addMessage({text:a.name+": "+a.text,delay:10,type:"chat"}),a.date>(new Date).getTime()-5e3&&g.add(g.types.CHAT,a.name+": "+a.text)}),b.login=function(){f.login(b.name,b.pwd),a.isSignedIn=f.isSignedIn()},b.test=function(){console.log("ok")},b.signup=function(){f.signup(b,b.name,b.email,b.pwd),a.isSignedIn=f.isSignedIn()},a.logout=function(){f.logout(),a.isSignedIn=!1},b.addMsg=function(a,c){c&&(e.addMessage(a,c),b.msg="")},b.deleteMsg=function(a){var c=j(a);e.deleteMessage(a),b.chat_messages.splice(c,1)}}]),angular.module("gameApp").controller("GameCtrl",["$rootScope","$scope","$timeout","$location","Db","Game","Session","MainPlayer",function(a,b,c,d,e,f,g,h){function i(a){var b=null;return r.some(function(c){return c.id==a?(b=c,void 0):void 0}),b}function j(a,b){var c=i(a);if(c){c.move(b.pos,b.rot);var d=null!=b.connections;c.onlinePresence!=d&&f.addMessage({text:c.name+" is now "+(d?"online":"offline"),delay:10,type:d?"info":"error"}),c.updateOnlinePresence(d)}}function k(a){b.pos=a.pos}function l(a){a&&(b.inventory=a),b.showInventory=!b.showInventory}function m(a){a=a?1e3*a:4e3,c(function(){b.msgs.splice(0,1),0==b.msgs.length?b.showConsole=!1:m(b.msgs[0].delay)},a)}function n(a){console.log(a),b.msgs.push(a),b.showConsole=!0,1==b.msgs.length&&m(a.delay)}var o=g.getUser();if(!o)return d.path("/"),void 0;b.showInventory=!1,b.showConsole=!1,b.msgs=[],c(function(){f.addMessage({text:"Welcome !",type:"system",delay:4})},4e3),c(function(){f.addMessage({text:"La position des autres joueurs n'est pas mise à jour en temps réel. C'est normal pour l'instant. Ce n'est pas du lag :)",type:"system",delay:7})},6e3),b.selectInventory=function(a){b.selectedInventoryObject=b.selectedInventoryObject==a.id?null:a.id,b.showInventory=!1};var p=f.init(n);if(p)console.log("Game was already initialized");else{f.addMainPlayer(h.newPlayer(o.id,o.name,o.pos,k,l));var q=a.users,r=[];for(var s in q)if(q[s].id!=o.id){var t=e.newPlayer(q[s].id,q[s].name,q[s].pos,q[s].rot,j),u=f.addPNJ(t);u.updateOnlinePresence(null!=t.connections),r.push(u)}console.log(r.length+" pnjs")}$("#instructions").click(function(){enablePointerLock()})}]),angular.module("gameApp").controller("UsersCtrl",["$scope","Db",function(){}]),angular.module("gameApp").controller("HeaderCtrl",["$scope","$location",function(a,b){a.isActive=function(a){return a===b.path()}}]),angular.module("gameApp.services.db",[]).factory("Db",["$rootScope","$location",function(a){function b(a,b){a.$$phase||a.$root.$$phase?b():a.$apply(b)}function c(){if(!m)throw"connect called without any user";var a=new Firebase(h.firebaseUrl+"/users/"+m.id+"/connections"),b=new Firebase(h.firebaseUrl+"/users/"+m.id+"/date"),c=new Firebase(h.firebaseUrl+"/.info/connected");c.on("value",function(c){if(c.val()===!0){b.set(Firebase.ServerValue.TIMESTAMP);var d=a.push(!0);d.onDisconnect().remove(),b.onDisconnect().set(Firebase.ServerValue.TIMESTAMP)}})}function d(c){i.once("value",function(d){null!==d.val()&&b(a,function(){c(d.val())})})}function e(c){i.on("child_added",function(d){null!==d.val()&&b(a,function(){c(d.val())})})}function f(a,b,c,d,e,f){return{id:a,name:b,email:c,pos:d,rot:e,inventory:f}}function g(c,d,e){b(a,function(){e(c,d.val())})}var h={firebaseUrl:"https://voxelgame.firebaseio.com"},i=new Firebase(h.firebaseUrl+"/users"),j=new Firebase(h.firebaseUrl+"/tchat"),k=new Firebase(h.firebaseUrl+"/cubes"),l=new Firebase(h.firebaseUrl+"/cubelist"),m=null,n=(new Date).getTime(),o=(new Date).getTime(),p=1e3;return a.users=[],e(function(b){a.users.push(b)}),{getUsers:d,getUser:function(){return m},setUser:function(a){m=a,c()},addUser:function(a,b,c){var d=i.push().name(),e={id:d,name:a,email:b,date:Firebase.ServerValue.TIMESTAMP};i.child(d).set(e),c&&c(e)},newUser:f,newPlayer:function(c,d,e,f,g){var i=new Firebase(h.firebaseUrl+"/users/"+c);return i.on("value",function(d){b(a,function(){g(c,d.val())})}),{id:c,name:d,pos:e,rot:f}},addMessage:function(a,b){var c=j.push().name();j.child(c).set({id:c,name:a,text:b,date:Firebase.ServerValue.TIMESTAMP})},deleteMessage:function(a){j.child(a).remove()},onChatMsg:function(c){j.off("child_added"),j.limit(10).on("child_added",function(d){b(a,function(){c(d.val())})})},onCube:function(a){l.on("child_added",function(b){g("added",b,a)}),l.on("child_changed",function(b){g("changed",b,a)}),l.on("child_removed",function(b){g("removed",b,a)})},put:function(a,b,c,d,e){m&&k.child("pos").child(a).child(b).child(c).once("value",function(f){if(f.val())throw"There is a cube in Db here";var g=l.push().name(),h=(new Date).getTime();k.child("pos").child(a).child(b).child(c).update({id:g,type:d,user:m.id,date:h});var i={id:g,type:d,user:m.id,date:h,x:a,y:b,z:c};l.child(g).update(i),e&&e(i)})},addInventory:function(a){if(m){var b=i.child(m.id).child("inventory").push().name(),c={id:b,type:a.type,date:Firebase.ServerValue.TIMESTAMP};return i.child(m.id).child("inventory").child(b).update(c),a.attrs&&(i.child(m.id).child("inventory").child(b).child("attrs").update(a.attrs),c.attrs=a.attrs),c}},removeInventory:function(a){m&&i.child(m.id).child("inventory").child(a).remove()},remove:function(a){m&&l.child(a).once("value",function(b){var c=b.val();if(!c)throw"no cube in Db here";k.child("pos").child(c.x).child(c.y).child(c.z).remove(),l.child(a).remove()})},updatePos:function(a){if(m){var b=(new Date).getTime();if(!(n>b-p)){n=b;var c=i.child(m.id);c.child("pos").update(a),c.update({date:b})}}},updateRot:function(a){if(m){var b=(new Date).getTime();if(!(o>b-p)){o=b;var c=i.child(m.id);c.child("rot").update(a),c.update({date:(new Date).getTime()})}}}}}]),angular.module("gameApp.services.session",[]).factory("Session",["$rootScope","Db",function(a,b){function c(a){var b=null;return e.some(function(c){return c.name==a?(b=c,void 0):void 0}),b}var d=null,e=[],f=null;return b.getUsers(function(a){for(var c in a)e.push(b.newUser(c,a[c].name,a[c].email,a[c].pos,a[c].rot,a[c].inventory));f&&f(),console.log("Session: "+e.length+" users")}),{onUsersLoad:function(a){f=a,e.length>0&&f&&f()},getUser:function(){return d},isSignedIn:function(){return d?(b.setUser(d),!0):(d=c(readCookie("voxelgame_name")),d&&b.setUser(d),null!=d)},changeLogin:function(a){d=c(a)},login:function(a){d=c(a),d&&(writeCookie("voxelgame_name",d.name,20),b.setUser(d))},signup:function(a,d,f){if(a.error="",0==e.length)return console.log("no users yet"),a.error="waiting for users to load, try again in 2 seconds",void 0;if(!d)return console.log("name is empty"),a.error="name can not be empty",void 0;var g=c(d);return g?(a.error="User already exists",void 0):(g?(a.error="pseudo "+d+" is already taken",a.name=""):(f||(f=""),b.addUser(d,f,function(a){e.push(a)}),a.pwd="enregistré!",writeCookie("voxelgame_name",d,20),a.error=""),void 0)},logout:function(){d=null,writeCookie("voxelgame_name","",20)}}}]),angular.module("gameApp.services.game",[]).factory("Game",["$rootScope","$location","Db","Session",function(a,b,c){function d(a,b){a.$$phase||a.$root.$$phase?b():a.$apply(b)}function e(a){var b,c,d=a.lensFlares.length,e=2*-a.positionScreen.x,f=2*-a.positionScreen.y;for(b=0;d>b;b++)c=a.lensFlares[b],c.x=a.positionScreen.x+e*c.distance,c.y=a.positionScreen.y+f*c.distance,c.rotation=0;a.lensFlares[2].y+=.025,a.lensFlares[3].rotation=.5*a.positionScreen.x+THREE.Math.degToRad(45)}function f(a,b,c,d,f,g){var h=new THREE.DirectionalLight(16777215,1.5);h.color.setHSL(a,b,c),h.position.set(d,f,g),h.castShadow=!0,h.shadowDarkness=.8,z.add(h),h=new THREE.PointLight(16777215,1,0),h.color.setHSL(a,b,c),h.position.set(d,f,g);var i=new THREE.Color(16777215);i.setHSL(a,b,c+.5);var j=new THREE.LensFlare(N,700,0,THREE.AdditiveBlending,i);j.add(O,512,0,THREE.AdditiveBlending),j.add(O,512,0,THREE.AdditiveBlending),j.add(O,512,0,THREE.AdditiveBlending),j.add(P,60,.6,THREE.AdditiveBlending),j.add(P,70,.7,THREE.AdditiveBlending),j.add(P,120,.9,THREE.AdditiveBlending),j.add(P,70,1,THREE.AdditiveBlending),j.customUpdateCallback=e,j.position=h.position,z.add(j)}function g(){return L.map(function(a){return a.mesh})}function h(){z=new THREE.Scene,z.fog=new THREE.Fog(3355443,300,1e3),D=new THREE.AmbientLight(16777215),D.color.setHSL(.1,.3,.2),z.add(D),f(.995,.5,.9,0,500,300),Config.modeDebug&&t(),I=new THREEx.RendererStats,I.domElement.style.position="absolute",I.domElement.style.right="0px",I.domElement.style.top="50px",A=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),A.setClearColor(3355443),A.shadowMapEnabled=!0,A.shadowMapSoft=!0,window.addEventListener("resize",p,!1),q(),c.onCube(o),G=!0}function i(a){var b=G;return M=a,H=!1,G||h(),y=$("#game"),p(),y.append(I.domElement),y.append(A.domElement),r(),b}function j(b){M&&d(a,function(){M(b)})}function k(a){for(var b in L)if(L[b].obj&&L[b].obj.id==a.id)return b;return null}function l(a){if(k(a))throw"There is a cube there. Check it before you call addCubeToScene.";var b=new THREE.Mesh(B,K);b.position.x=a.x*Config.dimCadri,b.position.y=a.y*Config.dimCadri,b.position.z=a.z*Config.dimCadri,Config.randomCubeRotation&&randomizeRot(b,Config.randomCubeRotationFactor),b.castShadow=!0,b.receiveShadow=!0,z.add(b),L.push({obj:a,mesh:b})}function m(a){z.remove(L[a].mesh),L.splice(a,1)}function n(a){var b=k(a);b?m(b):(console.error("did not find cube"),console.error(a))}function o(a,b){b.date>(new Date).getTime()-1e4&&console.log("cube "+a+" on "+b.x+", "+b.y+", "+b.z),"added"==a?l(b):"removed"==a?n(b):console.error("unknown onCube type "+a)}function p(){C&&(C.camera.aspect=window.innerWidth/window.innerHeight,C.camera.updateProjectionMatrix());var a=window.innerWidth-2*y[0].offsetLeft,b=window.innerHeight-y[0].offsetTop-5;y[0].style.width=a,y[0].style.height=b,A.setSize(a,b)}function q(){function a(a){if(!isLocked){var b=a.movementX||a.mozMovementX||a.webkitMovementX||0,d=a.movementY||a.mozMovementY||a.webkitMovementY||0;C.corps.rotation.y-=.002*b,C.tete.rotation.x-=.002*d,c.updateRot({corps:C.corps.rotation.y,tete:C.tete.rotation.x})}}var b=function(a){if(!isLocked)switch(a.keyCode){case 90:C.moveForward=!0;break;case 81:C.moveLeft=!0;break;case 83:C.moveBackward=!0;break;case 68:C.moveRight=!0;break;case 32:C.jump(!0);break;case 65:C.getCube();break;case 69:C.putCube();break;case 73:C.toggleInventory()}},d=function(a){switch(a.keyCode){case 38:case 90:C.moveForward=!1;break;case 37:case 81:C.moveLeft=!1;break;case 40:case 83:C.moveBackward=!1;break;case 39:case 68:C.moveRight=!1}};document.addEventListener("mousemove",a,!1),document.addEventListener("keydown",b,!1),document.addEventListener("keyup",d,!1),document.addEventListener("mousewheel",function(a){return isLocked?void 0:(C.camdist(a.wheelDelta),!1)},!1),document.addEventListener("mousedown",w,!1),document.addEventListener("mouseup",x,!1)}function r(){H||requestAnimationFrame(r),E=(new Date).getTime(),F=1e3/(E-Q),Q=E,Config.speedFactor=60/F,I.update(A),C&&(isLocked||(C.move(),C.jump()),A.render(z,C.camera),C.corps.position.y<-150&&s())}function s(){j({text:"You're dead...",delay:5,type:"info"}),C.corps.position.x=0,C.corps.position.y=Config.dimCadri+10,C.corps.position.z=0}function t(){J[0]=new v,z.add(J[0].mesh),J[1]=new v,z.add(J[1].mesh),J[2]=new v,z.add(J[2].mesh)}function u(a){a.pos||(a.pos={x:0,y:Config.dimCadri,z:0}),a.rot||(a.rot={corps:0,tete:0}),this.id=a.id,this.name=a.name,this.onlinePresence=!1,this.corps=new THREE.Object3D,copyVector(this.corps.position,a.pos);var b=Config.dimCadri,c=new THREE.CubeGeometry(b,b,b),d=new THREE.MeshLambertMaterial({color:16776960,transparent:!0});this.torse=new THREE.Mesh(c,d),this.corps.add(this.torse),this.torse.castShadow=!0,this.torse.receiveShadow=!0;var e=new THREE.CubeGeometry(b/2,b/2,b/2);this.tete=new THREE.Mesh(e,d),this.tete.castShadow=!0,this.tete.receiveShadow=!0,this.tete.position.y=b,this.tete.position.z=b/4,this.corps.add(this.tete);var f=new THREE.TextGeometry(a.name,{font:"optimer",weight:"normal",style:"normal",size:4,height:.5,curveSegments:2,bevelThickness:.1,bevelSize:.1,bevelEnabled:!0}),g=new THREE.MeshPhongMaterial({color:16755200,transparent:!0});this.name_label=new THREE.Mesh(f,g);var h=new THREE.Box3;h.setFromObject(this.name_label);var i=(h.max.x-h.min.x)/2;return this.name_label.position.y=.25*b,this.name_label.position.z=.5*b,this.name_label.position.x=-i,this.corps.add(this.name_label),copyRotation(this,a.rot),z.add(this.corps),L.push({mesh:this.torse}),this.updateOnlinePresence=function(a){this.onlinePresence=a,a?(this.torse.material.opacity=1,this.tete.castShadow=!0,this.tete.receiveShadow=!0,this.torse.castShadow=!0,this.torse.receiveShadow=!0):(this.torse.material.opacity=.4,this.name_label.material.opacity=.4,this.tete.castShadow=!1,this.tete.receiveShadow=!1,this.torse.castShadow=!1,this.torse.receiveShadow=!1)},this.move=function(a,b){copyVector(this.corps.position,a),copyRotation(this,b)},this}function v(){this.mesh=new THREE.BoxHelper,this.mesh.scale.set(Config.dimCadri/2,Config.dimCadri/2,Config.dimCadri/2),this.mesh.visible=!1}function w(a){if(!isLocked){switch(a.button){case 0:C.dummy.mesh.material.color.setRGB(1,0,0);break;case 1:break;case 2:C.dummy.mesh.material.color.setRGB(0,1,0)}C.dummy.mesh.visible=!0}}function x(a){if(!isLocked)switch(C.dummy.mesh.visible=!1,a.button){case 0:C.getCube();break;case 1:break;case 2:C.putCube()}}var y,z,A,B,C,D,E,F,G=!1,H=!0,I=null,J=[],B=new THREE.CubeGeometry(Config.dimCadri,Config.dimCadri,Config.dimCadri),K=new THREE.MeshLambertMaterial({map:THREE.ImageUtils.loadTexture("images/crate01.jpg")}),L=[],M=null,N=THREE.ImageUtils.loadTexture("images/lensflare0.png"),O=THREE.ImageUtils.loadTexture("images/lensflare2.png"),P=THREE.ImageUtils.loadTexture("images/lensflare3.png"),Q=(new Date).getTime();return{init:function(a){return i(a)},stop:function(){H||console.log("Game rendering has been stopped but still receive DB updates"),H=!0},addMainPlayer:function(a){C=a,z.add(C.corps)},addPNJ:function(a){return new u(a)},getObjects:function(){return L},getMeshObjects:function(){return g()},addCubeToScene:function(a){l(a)},removeCubeFromScene:function(a){n(a)},removeCubeFromSceneByKey:function(a){m(a)},addGetPutDummy:function(){var a=new v;return z.add(a.mesh),a},addMessage:function(a){j(a)}}}]),angular.module("gameApp.services.mainplayer",[]).factory("MainPlayer",["$rootScope","$location","Db","Session","Game",function(a,b,c,d,e){function f(a,b){a.$$phase||a.$root.$$phase?b():a.$apply(b)}function g(b,g,h,i,j){h||(h={x:0,y:50,z:0});var k=null;d.onUsersLoad(function(){if(k=d.getUser(),k.inventory){var a=$.map(k.inventory,function(a){return[a]});k.inventory=a}else{var b=c.addInventory({type:CubeTypes.WoodBlock});k.inventory=[b]}}),this.dummy=e.addGetPutDummy();var l=Config.distCamPlayer,m=.66*Config.dimCadri,n=j,o=document.createElement("audio"),p=document.createElement("source");p.src="sounds/ammo_bounce.wav",o.appendChild(p),o.play();var q=!0,r=0,s=new THREE.Vector3(h.x,h.y,h.z);this.name=g,this.jumping=!1,this.corps=new THREE.Object3D,this.corps.position.copy(h);var t=THREE.ImageUtils.loadTexture("images/ash_uvgrid01.jpg");t.wrapS=t.wrapT=THREE.RepeatWrapping,t.anisotropy=16;var u=new THREE.MeshLambertMaterial({ambient:12303291,map:t}),v=Config.dimCadri,w=new THREE.CubeGeometry(v,v,v);this.torse=new THREE.Mesh(w,u),this.torse.castShadow=!0,this.torse.receiveShadow=!0,this.corps.add(this.torse);var x=new THREE.CubeGeometry(v/2,v/2,v/2);this.tete=new THREE.Mesh(x,u),this.tete.castShadow=!0,this.tete.receiveShadow=!0,this.tete.position.y=v,this.tete.position.z=-v/4,this.corps.add(this.tete),this.camera=new THREE.PerspectiveCamera(Config.viewwAngle,window.innerWidth/window.innerHeight,1,1e3),this.camera.position.x+=Math.sin(this.corps.rotation.y)*l,this.camera.position.z+=Math.cos(this.corps.rotation.y)*l,this.tete.add(this.camera),this.updateCamera=function(){this.camera.position.x+=(this.tete.position.x-this.camera.position.x)/10,this.camera.position.y+=(this.tete.position.y-this.camera.position.y-Config.dimCadri/2)/10},this.move=function(){var a=this.canMove();if(a&&(0!=a.x||0!=a.z)){s.copy(this.corps.position),s.x+=a.x*Config.playerSpeed*Config.speedFactor,s.z+=a.z*Config.playerSpeed*Config.speedFactor,this.corps.position.copy(s);var b={x:s.x,y:s.y,z:s.z};if(c.updatePos(b),Config.randomCubeRotation&&!this.jumping){var d={rotation:{x:0,y:0,z:0}};randomizeRot(d,.02),copyVector(this.torse.rotation,d.rotation)}}},this.canMove=function(){var a=[],b=[],c=Math.PI/4;a[0]=0,b[0]=0,a[1]=0,b[1]=0,a[2]=0,b[2]=0,this.moveForward&&(a[0]-=Math.sin(this.corps.rotation.y-c),b[0]-=Math.cos(this.corps.rotation.y-c),a[1]-=Math.sin(this.corps.rotation.y),b[1]-=Math.cos(this.corps.rotation.y),a[2]-=Math.sin(this.corps.rotation.y+c),b[2]-=Math.cos(this.corps.rotation.y+c)),this.moveBackward&&(a[0]+=Math.sin(this.corps.rotation.y-c),b[0]+=Math.cos(this.corps.rotation.y-c),a[1]+=Math.sin(this.corps.rotation.y),b[1]+=Math.cos(this.corps.rotation.y),a[2]+=Math.sin(this.corps.rotation.y+c),b[2]+=Math.cos(this.corps.rotation.y+c)),this.moveLeft&&(a[0]-=Math.sin(this.corps.rotation.y+Math.PI/2-c),b[0]-=Math.cos(this.corps.rotation.y+Math.PI/2-c),a[1]-=Math.sin(this.corps.rotation.y+Math.PI/2),b[1]-=Math.cos(this.corps.rotation.y+Math.PI/2),a[2]-=Math.sin(this.corps.rotation.y+Math.PI/2+c),b[2]-=Math.cos(this.corps.rotation.y+Math.PI/2+c)),this.moveRight&&(a[0]-=Math.sin(this.corps.rotation.y-Math.PI/2-c),b[0]-=Math.cos(this.corps.rotation.y-Math.PI/2-c),a[1]-=Math.sin(this.corps.rotation.y-Math.PI/2),b[1]-=Math.cos(this.corps.rotation.y-Math.PI/2),a[2]-=Math.sin(this.corps.rotation.y-Math.PI/2+c),b[2]-=Math.cos(this.corps.rotation.y-Math.PI/2+c));for(var d={x:a[1],z:b[1]},f=e.getMeshObjects(),g=0;3>g;g++){var h=new THREE.Raycaster(this.corps.position,new THREE.Vector3(a[g]*m,0,b[g]*m).normalize()),i=h.intersectObjects(f);i.length>0&&i[0].distance<m&&(o.play(),d=!1)}var j=25;return this.dummy.mesh.position.y=Math.round((this.corps.position.y+Math.sin(this.tete.rotation.x)*j+Config.dimCadri/2)/Config.dimCadri)*Config.dimCadri,this.dummy.mesh.position.x=Math.round((this.corps.position.x-Math.sin(this.corps.rotation.y)*j*Math.cos(this.tete.rotation.x))/Config.dimCadri)*Config.dimCadri,this.dummy.mesh.position.z=Math.round((this.corps.position.z-Math.cos(this.corps.rotation.y)*j*Math.cos(this.tete.rotation.x))/Config.dimCadri)*Config.dimCadri,d},this.jump=function(a){a&&(this.jumping=!0),q&&1==this.jumping&&(q=!1,r=4.3);var b=!0,c=new THREE.Raycaster(this.corps.position,new THREE.Vector3(0,-1,0)),d=c.intersectObjects(e.getMeshObjects());d.length>0&&d[0].distance<m&&(b=!1),0>r&&(this.jumping=!1),b||1==this.jumping?(r>-5&&(r-=.2*Config.speedFactor),this.corps.position.y+=r):(0>r&&(r=0),q=!0,this.jumping=!1)},this.toggleInventory=function(){n&&f(a,function(){n(k.inventory)})},this.getCube=function(){if(k.inventory.length>=Config.maxInventory)return e.addMessage({text:"Too many objects in inventory",delay:5,type:"error"}),void 0;var a=this.canGet();if(a){var b=e.getObjects();c.remove(b[a].obj.id);var d=c.addInventory({type:CubeTypes.WoodBlock});k.inventory.push(d),e.addMessage({text:"ok, in inventory",delay:3,type:"info"})}else e.addMessage({text:"No cube here !",delay:3,type:"error"})},this.canGet=function(){var a=e.getMeshObjects(),b=2*Config.dimCadri,c=new THREE.Vector3(this.corps.position.x+this.tete.position.x,this.corps.position.y+this.tete.position.y,this.corps.position.z+this.tete.position.z),d=new THREE.Vector3(this.dummy.mesh.position.x-c.x,this.dummy.mesh.position.y-c.y,this.dummy.mesh.position.z-c.z).normalize(),f=new THREE.Raycaster(c,d),g=f.intersectObjects(a);if(g.length>0&&g[0].distance<b)for(var h in a)if(a[h].id==g[0].object.id)return h;return null},this.putCube=function(){var a=k.inventory.pop();if(!a)return e.addMessage({text:"Nothing in inventory!",delay:3,type:"error"}),void 0;var b=this.canGet();if(b)return e.addMessage({text:"There is a cube there",delay:3,type:"error"}),void 0;var d={x:this.dummy.mesh.position.x/Config.dimCadri,y:this.dummy.mesh.position.y/Config.dimCadri,z:this.dummy.mesh.position.z/Config.dimCadri};c.put(d.x,d.y,d.z,a.type),c.removeInventory(a.id)},this.setCamDist=function(a){var b=5,c=a;b>c&&(c=b),this.camera.position.x=this.tete.position.x+Math.sin(this.tete.rotation.y)*c,this.camera.position.z=this.tete.position.z+Math.cos(this.tete.rotation.y)*c,b>a?(this.camera.fov=Config.viewAngle-a/1.5,this.camera.updateProjectionMatrix()):this.camera.fov!=Config.viewAngle&&(this.camera.fov=Config.viewAngle,this.camera.updateProjectionMatrix())},this.camdist=function(a){l-=a/10,-60>l&&(l=-60),this.setCamDist(l)},this.setCamDist(Config.distCamPlayer)}return{newPlayer:function(a,b,c,d,e){return new g(a,b,c,d,e)}}}]),angular.module("gameApp.services.notification",[]).factory("Notification",["$rootScope",function(){return{types:{CHAT:{title:"Jethro koull",icon:"http://www.cusi.fr/site/tchat-enfant/im/msn.jpg"}},enable:function(){"undefined"!=typeof webkitNotifications&&0!=webkitNotifications.checkPermission()&&(console.log("no notification permissions"),webkitNotifications.requestPermission())},add:function(a,b){if("undefined"!=typeof webkitNotifications)try{webkitNotifications.createNotification(a.icon,a.title,b).show()}catch(c){console.log(c.message)}}}}]);