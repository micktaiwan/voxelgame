"use strict";angular.module("gameApp",["ngCookies","ngResource","ngSanitize","gameApp.services.db","gameApp.services.session","gameApp.services.notification","gameApp.services.game","gameApp.services.mainplayer"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/game",{templateUrl:"views/game.html",controller:"GameCtrl"}).when("/users",{templateUrl:"views/users.html",controller:"UsersCtrl"}).when("/about",{templateUrl:"views/about.html"}).otherwise({redirectTo:"/"})}]),Date.prototype.getWeek=function(){var a=new Date(this.getFullYear(),0,1);return Math.ceil(((this-a)/864e5+a.getDay()+1)/7)},angular.module("gameApp").controller("MainCtrl",["$rootScope","$scope","$location","$timeout","Db","Session","Notification",function(a,b,c,d,e,f,g){function h(){a.isSignedIn=f.isSignedIn();var c=f.getUser();c&&(b.name=c.name)}function i(a){console.log(a);var c=$.map(b.chat_messages,function(b,c){return b.id==a?c:void 0});return c[0]}a.current_date=(new Date).getTime(),a.weekNumber=(new Date).getWeek(),b.chat_messages=[],g.enable(),h(),f.onUsersLoad(h),b.login=function(){f.login(b.name,b.pwd),a.isSignedIn=f.isSignedIn()},b.signup=function(){f.signup(b,b.name,b.email,b.pwd),a.isSignedIn=f.isSignedIn()},a.logout=function(){f.logout(),a.isSignedIn=!1},e.getChatMsg(function(a){b.chat_messages.push(a),a.date>(new Date).getTime()-1e4&&g.add(g.types.CHAT,a.name+": "+a.text)}),b.addMsg=function(a,c){e.addMessage(a,c),b.msg=""},b.deleteMsg=function(a){var c=i(a);b.chat_messages.splice(c,1),e.deleteMessage(a)}}]),angular.module("gameApp").controller("GameCtrl",["$rootScope","$scope","$timeout","$location","Db","Game","Session","MainPlayer",function(a,b,c,d,e,f,g,h){function i(a){var b=null;return r.some(function(c){return c.id==a?(b=c,void 0):void 0}),b}function j(a,b){var c=i(a);c&&c.move(b.pos,b.rot)}function k(a){b.pos=a.pos}function l(a){console.log(a),b.inventory=a,b.nbInventory=a.length,b.showInventory=!b.showInventory}function m(){c(function(){b.msgs.splice(0,1),0==b.msgs.length?b.showConsole=!1:m()},4e3)}function n(a){b.msgs.push(a),b.showConsole=!0,m()}var o=g.getUser();if(!o)return d.path("/"),void 0;b.showInventory=!1,b.showConsole=!1,b.msgs=[],f.init(n);var p=h.newPlayer(o.id,o.name,o.pos,k,l);f.addMainPlayer(p);var q=a.users,r=[];for(var s in q)if(q[s].id!=o.id){var p=e.newPlayer(q[s].id,q[s].name,q[s].pos,q[s].rot,j);r.push(f.addPNJ(p.id,p.name,p.pos,p.rot))}console.log(r.length+" pnjs"),f.animate(),$("#instructions").click(function(){enablePointerLock()})}]),angular.module("gameApp").controller("UsersCtrl",["$scope","Db",function(){}]),angular.module("gameApp").controller("HeaderCtrl",["$scope","$location",function(a,b){a.isActive=function(a){return a===b.path()}}]),angular.module("gameApp.services.db",[]).factory("Db",["$rootScope","$location",function(a){function b(a,b){a.$$phase||a.$root.$$phase?b():a.$apply(b)}function c(c){h.once("value",function(d){null!==d.val()&&b(a,function(){c(d.val())})})}function d(c){h.on("child_added",function(d){null!==d.val()&&b(a,function(){c(d.val())})})}function e(a,b,c,d,e,f){return{id:a,name:b,email:c,pos:d,rot:e,inventory:f}}function f(c,d,e){b(a,function(){e(c,d.val())})}var g={firebaseUrl:"https://voxelgame.firebaseio.com"},h=new Firebase(g.firebaseUrl+"/users"),i=new Firebase(g.firebaseUrl+"/tchat"),j=new Firebase(g.firebaseUrl+"/cubes"),k=new Firebase(g.firebaseUrl+"/cubelist"),l=null;return a.users=[],d(function(b){a.users.push(b)}),{getUsers:c,getUser:function(){return l},setUser:function(a){l=a},addUser:function(a,b,c){var d=h.push().name(),e={id:d,name:a,email:b};h.child(d).set(e),c&&c(e)},newUser:e,newPlayer:function(c,d,e,f,h){var i=new Firebase(g.firebaseUrl+"/users/"+c);return i.on("value",function(d){b(a,function(){h(c,d.val())})}),{id:c,name:d,pos:e,rot:f}},addMessage:function(a,b){var c=i.push().name();i.child(c).set({id:c,name:a,text:b,date:(new Date).getTime()})},deleteMessage:function(a){i.child(a).remove()},getChatMsg:function(c){i.limit(10).on("child_added",function(d){b(a,function(){c(d.val())})})},onCube:function(a){k.on("child_added",function(b){f("added",b,a)}),k.on("child_changed",function(b){f("changed",b,a)}),k.on("child_removed",function(b){f("removed",b,a)})},put:function(a,b,c,d){l&&j.child("pos").child(a).child(b).child(c).once("value",function(e){if(!e.val()){var f=k.push().name(),g=(new Date).getTime();j.child("pos").child(a).child(b).child(c).update({id:f,type:d,user:l.id,date:g}),k.child(f).update({id:f,type:d,user:l.id,date:g,x:a,y:b,z:c})}})},addInventory:function(a){if(l){var b=h.child(l.id).child("inventory").push().name(),c={id:b,type:a.type,date:(new Date).getTime()};return h.child(l.id).child("inventory").child(b).update(c),a.attrs&&(h.child(l.id).child("inventory").child(b).child("attrs").update(a.attrs),c.attrs=a.attrs),c}},remove:function(a,b,c){l&&j.child("pos").child(a).child(b).child(c).once("value",function(d){var e=d.val();if(e){var f=e.id;j.child("pos").child(a).child(b).child(c).remove(),k.child(f).remove()}})},updatePos:function(a){if(l){var b=h.child(l.id);b.child("pos").update(a),b.update({date:(new Date).getTime()})}},updateRot:function(a){if(l){var b=h.child(l.id);b.child("rot").update(a),b.update({date:(new Date).getTime()})}}}}]),angular.module("gameApp.services.session",[]).factory("Session",["$rootScope","Db",function(a,b){function c(a){var b=null;return e.some(function(c){return c.name==a?(b=c,void 0):void 0}),b}var d=null,e=[],f=null;return b.getUsers(function(a){for(var c in a)e.push(b.newUser(c,a[c].name,a[c].email,a[c].pos,a[c].rot,a[c].inventory));f&&f(),console.log("Session: "+e.length+" users")}),{onUsersLoad:function(a){f=a,e.length>0&&f&&f()},getUser:function(){return d},isSignedIn:function(){return d?(b.setUser(d),!0):(d=c(readCookie("voxelgame_name")),d&&b.setUser(d),null!=d)},changeLogin:function(a){d=c(a)},login:function(a){d=c(a),d&&(writeCookie("voxelgame_name",d.name,20),b.setUser(d))},signup:function(a,d,f){if(a.error="",0==e.length)return console.log("no users yet"),a.error="waiting for users to load, try again in 2 seconds",void 0;if(!d)return console.log("name is empty"),a.error="name can not be empty",void 0;var g=c(d);return g?(a.error="User already exists",void 0):(g?(a.error="pseudo "+d+" is already taken",a.name=""):(f||(f=""),b.addUser(d,f,function(a){e.push(a)}),a.pwd="enregistr√©!",writeCookie("voxelgame_name",d,20),a.error=""),void 0)},logout:function(){d=null,writeCookie("voxelgame_name","",20)}}}]),angular.module("gameApp.services.game",[]).factory("Game",["$rootScope","$location","Db","Session",function(a,b,c){function d(a,b){a.$$phase||a.$root.$$phase?b():a.$apply(b)}function e(a,b){a.x=b.x,a.y=b.y,a.z=b.z}function f(a,b){a.corps.rotation.y=b.corps,a.tete.rotation.x=b.tete}function g(a){F=a,x=new THREE.Scene,x.fog=new THREE.Fog(4473924,0,600),B=new THREE.AmbientLight(4473924),x.add(B),B=new THREE.SpotLight(16777215,1,1e4,45),B.position.set(0,1e3,1e3),B.castShadow=!0,B.shadowCameraNear=100,B.shadowCameraFar=1e4,B.shadowCameraFov=30,x.add(B),Config.modeDebug&&r(),y=new THREE.WebGLRenderer,y.setClearColor(4487031),y.shadowMapEnabled=!0,w=$("#game"),n(),w.append(y.domElement),window.addEventListener("resize",n,!1),o(),c.onCube(m)}function h(b){F&&d(a,function(){F(b)})}function i(a){for(var b in E)if(E[b].position.x/Graphics.dimCadri==a.x&&E[b].position.y/Graphics.dimCadri==a.y&&E[b].position.z/Graphics.dimCadri==a.z)return b;return null}function j(a){if(!i(a)){var b=new THREE.Mesh(z,D);b.position.x=a.x*Graphics.dimCadri,b.position.y=a.y*Graphics.dimCadri,b.position.z=a.z*Graphics.dimCadri,b.castShadow=!0,b.receiveShadow=!0,x.add(b),E.push(b)}}function k(a){x.remove(E[a]),E.splice(a,1)}function l(a){var b=i(a);b&&k(b)}function m(a,b){"added"==a?j(b):"removed"==a?l(b):console.log("unknown onCube type "+a)}function n(){A&&(A.camera.aspect=window.innerWidth/window.innerHeight,A.camera.updateProjectionMatrix());var a=window.innerWidth-2*w[0].offsetLeft,b=window.innerHeight-2*w[0].offsetTop;y.setSize(a,b),w[0].style.width=a,w[0].style.height=b}function o(){var a=function(a){if(!isLocked){var b=a.movementX||a.mozMovementX||a.webkitMovementX||0,d=a.movementY||a.mozMovementY||a.webkitMovementY||0;A.corps.rotation.y-=.002*b,A.tete.rotation.x-=.002*d,A.tete.rotation.x<-Math.PI/2&&(A.tete.rotation.x=-Math.PI/2),A.tete.rotation.x>Math.PI/2&&(A.tete.rotation.x=Math.PI/2),c.updateRot({corps:A.corps.rotation.y,tete:A.tete.rotation.x})}},b=function(a){if(!isLocked)switch(a.keyCode){case 90:A.moveForward=!0;break;case 81:A.moveLeft=!0;break;case 83:A.moveBackward=!0;break;case 68:A.moveRight=!0;break;case 32:A.jumping=!0,A.jump();break;case 65:A.getCube();break;case 69:A.putCube();break;case 73:A.toggleInventory()}},d=function(a){switch(a.keyCode){case 38:case 90:A.moveForward=!1;break;case 37:case 81:A.moveLeft=!1;break;case 40:case 83:A.moveBackward=!1;break;case 39:case 68:A.moveRight=!1}};document.addEventListener("mousemove",a,!1),document.addEventListener("keydown",b,!1),document.addEventListener("keyup",d,!1),document.addEventListener("mousewheel",function(a){return isLocked?void 0:(A.camdist(a.wheelDelta),!1)},!1),document.addEventListener("mousedown",u,!1)}function p(){requestAnimationFrame(p),v.update(y),A&&(isLocked||(A.move(),A.jump()),y.render(x,A.camera),A.corps.position.y<-150&&q())}function q(){h("You're dead..."),A.corps.position.x=0,A.corps.position.y=Graphics.dimCadri+10,A.corps.position.z=0}function r(){C[0]=new t,x.add(C[0].mesh),C[1]=new t,x.add(C[1].mesh),C[2]=new t,x.add(C[2].mesh)}function s(a,b,c,d){c||(c={x:0,y:0,z:0}),d||(d={corps:0,tete:0}),this.id=a,this.name=b,this.corps=new THREE.Object3D,e(this.corps.position,c);var g=new THREE.CubeGeometry(Graphics.dimCadri/2,Graphics.dimCadri/2,Graphics.dimCadri/2),h=new THREE.MeshLambertMaterial({color:16776960}),i=new THREE.Mesh(g,h);this.corps.add(i),i.castShadow=!0,i.receiveShadow=!0;var j=new THREE.CubeGeometry(Graphics.dimCadri/4,Graphics.dimCadri/4,Graphics.dimCadri/4);this.tete=new THREE.Mesh(j,h),this.tete.castShadow=!0,this.tete.receiveShadow=!0,this.tete.position.y=Graphics.dimCadri/2,this.tete.position.z=Graphics.dimCadri/4,this.corps.add(this.tete);var k=new THREE.TextGeometry(b,{font:"optimer",weight:"normal",style:"normal",size:2,height:.5,bevelThickness:.1,bevelSize:.1,bevelEnabled:!0}),l=new THREE.MeshPhongMaterial({color:16755200});return this.name_label=new THREE.Mesh(k,l),this.name_label.position.y=.1*Graphics.dimCadri,this.name_label.position.z=.25*Graphics.dimCadri,this.name_label.position.x=-5,this.corps.add(this.name_label),f(this,d),x.add(this.corps),E.push(i),this.move=function(a,b){e(this.corps.position,a),f(this,b)},this}function t(){this.mesh=new THREE.BoxHelper,this.mesh.material.color.setRGB(0,1,0),this.mesh.scale.set(10,10,10),this.mesh.position.y=20,this.mesh.position.x=15,this.mesh.visible=!1}function u(a){if(!isLocked)switch(a.button){case 0:A.getCube();break;case 1:break;case 2:A.putCube()}}var v=new THREEx.RendererStats;v.domElement.style.position="absolute",v.domElement.style.left="0px",v.domElement.style.bottom="0px",document.body.appendChild(v.domElement);var w,x,y,z,A,B,C=[],z=new THREE.CubeGeometry(Graphics.dimCadri,Graphics.dimCadri,Graphics.dimCadri),D=new THREE.MeshLambertMaterial({map:THREE.ImageUtils.loadTexture("images/boite.jpg")}),E=[],F=null;return{init:function(a){g(a)},animate:function(){p()},addMainPlayer:function(a){A=a,x.add(A.corps)},addPNJ:function(a,b,c,d){return new s(a,b,c,d)},getObjects:function(){return E},addCubeToScene:function(a){j(a)},removeCubeFromScene:function(a){l(a)},removeCubeFromSceneByKey:function(a){k(a)},addGetPutDummy:function(){var a=new t;return x.add(a.mesh),a},addMessage:function(a){h(a)}}}]),angular.module("gameApp.services.mainplayer",[]).factory("MainPlayer",["$rootScope","$location","Db","Session","Game",function(a,b,c,d,e){function f(a,b){a.$$phase||a.$root.$$phase?b():a.$apply(b)}function g(b,g,h,i,j){h||(h={x:0,y:0,z:0});var k=null;d.onUsersLoad(function(){if(k=d.getUser(),k.inventory){var a=$.map(k.inventory,function(a){return[a]});k.inventory=a}else{var b=c.addInventory({type:CubeTypes.WoodBlock});k.inventory=[b]}});var l=e.addGetPutDummy(),m=Graphics.distCamPlayer,n=8,o=j,p=document.createElement("audio"),q=document.createElement("source");q.src="sounds/ammo_bounce.wav",p.appendChild(q),p.play();var r=!0,s=0,t=new THREE.Vector3(h.x,h.y,h.z);this.name=g,this.jumping=!1,this.corps=new THREE.Object3D,this.corps.position.copy(h);var u=THREE.ImageUtils.loadTexture("images/ash_uvgrid01.jpg");u.wrapS=u.wrapT=THREE.RepeatWrapping,u.anisotropy=16;var v=new THREE.MeshLambertMaterial({ambient:12303291,map:u}),w=new THREE.CubeGeometry(Graphics.dimCadri/2,Graphics.dimCadri/2,Graphics.dimCadri/2);this.torse=new THREE.Mesh(w,v),this.torse.castShadow=!0,this.torse.receiveShadow=!0,this.corps.add(this.torse);var x=new THREE.CubeGeometry(Graphics.dimCadri/4,Graphics.dimCadri/4,Graphics.dimCadri/4);this.tete=new THREE.Mesh(x,v),this.tete.castShadow=!0,this.tete.receiveShadow=!0,this.tete.position.y=Graphics.dimCadri/2,this.tete.position.z=-5,this.corps.add(this.tete),this.camera=new THREE.PerspectiveCamera(Graphics.viewwAngle,window.innerWidth/window.innerHeight,1,1e3),this.camera.position.x+=Math.sin(this.corps.rotation.y)*m,this.camera.position.z+=Math.cos(this.corps.rotation.y)*m,this.tete.add(this.camera),this.updateCamera=function(){this.camera.position.x+=(this.tete.position.x-this.camera.position.x)/10,this.camera.position.y+=(this.tete.position.y-this.camera.position.y-Graphics.dimCadri/2)/10},this.move=function(){if(this.moveForward||this.moveRight||this.moveLeft||this.moveBackward){var a=this.canMove();if(a&&(0!=a.x||0!=a.z)){t.copy(this.corps.position),t.x+=a.x*Config.playerSpeed,t.z+=a.z*Config.playerSpeed,this.corps.position.copy(t);var b={x:t.x,y:t.y,z:t.z};c.updatePos(b)}}},this.canMove=function(){var a=[],b=[],c=Math.PI/4;a[0]=0,b[0]=0,a[1]=0,b[1]=0,a[2]=0,b[2]=0,this.moveForward&&(a[0]-=Math.sin(this.corps.rotation.y-c),b[0]-=Math.cos(this.corps.rotation.y-c),a[1]-=Math.sin(this.corps.rotation.y),b[1]-=Math.cos(this.corps.rotation.y),a[2]-=Math.sin(this.corps.rotation.y+c),b[2]-=Math.cos(this.corps.rotation.y+c)),this.moveBackward&&(a[0]+=Math.sin(this.corps.rotation.y-c),b[0]+=Math.cos(this.corps.rotation.y-c),a[1]+=Math.sin(this.corps.rotation.y),b[1]+=Math.cos(this.corps.rotation.y),a[2]+=Math.sin(this.corps.rotation.y+c),b[2]+=Math.cos(this.corps.rotation.y+c)),this.moveLeft&&(a[0]-=Math.sin(this.corps.rotation.y+Math.PI/2-c),b[0]-=Math.cos(this.corps.rotation.y+Math.PI/2-c),a[1]-=Math.sin(this.corps.rotation.y+Math.PI/2),b[1]-=Math.cos(this.corps.rotation.y+Math.PI/2),a[2]-=Math.sin(this.corps.rotation.y+Math.PI/2+c),b[2]-=Math.cos(this.corps.rotation.y+Math.PI/2+c)),this.moveRight&&(a[0]-=Math.sin(this.corps.rotation.y-Math.PI/2-c),b[0]-=Math.cos(this.corps.rotation.y-Math.PI/2-c),a[1]-=Math.sin(this.corps.rotation.y-Math.PI/2),b[1]-=Math.cos(this.corps.rotation.y-Math.PI/2),a[2]-=Math.sin(this.corps.rotation.y-Math.PI/2+c),b[2]-=Math.cos(this.corps.rotation.y-Math.PI/2+c));for(var d={x:a[1],z:b[1]},f=0;3>f;f++){var g=new THREE.Raycaster(this.corps.position,new THREE.Vector3(a[f]*n,0,b[f]*n).normalize()),h=g.intersectObjects(e.getObjects());h.length>0&&h[0].distance<n&&(p.play(),d=!1)}var i=25;return l.mesh.position.y=Math.round((this.corps.position.y+Math.sin(this.tete.rotation.x)*i+Graphics.dimCadri/2)/Graphics.dimCadri)*Graphics.dimCadri,l.mesh.position.x=Math.round((this.corps.position.x-Math.sin(this.corps.rotation.y)*i*Math.cos(this.tete.rotation.x))/Graphics.dimCadri)*Graphics.dimCadri,l.mesh.position.z=Math.round((this.corps.position.z-Math.cos(this.corps.rotation.y)*i*Math.cos(this.tete.rotation.x))/Graphics.dimCadri)*Graphics.dimCadri,d},this.jump=function(){r&&1==this.jumping&&(r=!1,s=4.3);var a=!0,b=new THREE.Raycaster(this.corps.position,new THREE.Vector3(0,-1,0)),c=b.intersectObjects(e.getObjects());c.length>0&&c[0].distance<n&&(a=!1),0>s&&(this.jumping=!1),a||1==this.jumping?(s>-5&&(s-=.2),this.corps.position.y+=s):(0>s&&(s=0),r=!0,this.jumping=!1)},this.toggleInventory=function(){o&&f(a,function(){o(k.inventory)})},this.getCube=function(){var a=this.canGet(),b=e.getObjects();if(a){c.remove(b[a].position.x/Graphics.dimCadri,b[a].position.y/Graphics.dimCadri,b[a].position.z/Graphics.dimCadri),e.removeCubeFromSceneByKey(a);var d=c.addInventory({type:CubeTypes.WoodBlock});k.inventory.push(d),e.addMessage(a+" in inventory (really)")}else console.log("no cube here !")},this.canGet=function(){var a=e.getObjects(),b=Graphics.dimCadri,c=new THREE.Vector3(this.corps.position.x+this.tete.position.x,this.corps.position.y+this.tete.position.y,this.corps.position.z+this.tete.position.z),d=new THREE.Vector3(l.mesh.position.x-c.x,l.mesh.position.y-c.y,l.mesh.position.z-c.z).normalize(),f=new THREE.Raycaster(c,d),g=f.intersectObjects(a);if(g.length>0&&g[0].distance<b)for(var h in a)if(a[h].id==g[0].object.id)return h;return null},this.putCube=function(){l.mesh.visible=!1;var a={x:l.mesh.position.x/Graphics.dimCadri,y:l.mesh.position.y/Graphics.dimCadri,z:l.mesh.position.z/Graphics.dimCadri};e.addCubeToScene(a),c.put(a.x,a.y,a.z,CubeTypes.WoodBlock)},this.setCamDist=function(a){this.camera.position.x=this.tete.position.x+Math.sin(this.tete.rotation.y)*a,this.camera.position.z=this.tete.position.z+Math.cos(this.tete.rotation.y)*a},this.camdist=function(a){m-=a/30,0>m&&(m=0),m>200&&(m=200),this.setCamDist(m)},this.setCamDist(Graphics.distCamPlayer)}return{newPlayer:function(a,b,c,d,e){return new g(a,b,c,d,e)}}}]),angular.module("gameApp.services.notification",[]).factory("Notification",["$rootScope",function(){return{types:{CHAT:{title:"Jethro koull",icon:"http://www.cusi.fr/site/tchat-enfant/im/msn.jpg"}},enable:function(){0!=webkitNotifications.checkPermission()&&(console.log("no notification permissions"),webkitNotifications.requestPermission())},add:function(a,b){try{webkitNotifications.createNotification(a.icon,a.title,b).show()}catch(c){console.log(c.message)}}}}]);