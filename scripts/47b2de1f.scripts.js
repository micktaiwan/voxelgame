"use strict";angular.module("gameApp",["ngCookies","ngResource","ngSanitize","ngRoute","gameApp.services.db","gameApp.services.session","gameApp.services.notification","gameApp.services.game","gameApp.services.mainplayer","gameApp.services.robot","gameApp.services.map"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/game",{templateUrl:"views/game.html",controller:"GameCtrl"}).when("/users",{templateUrl:"views/users.html",controller:"UsersCtrl"}).when("/about",{templateUrl:"views/about.html"}).otherwise({redirectTo:"/"})}]),angular.module("gameApp.services.map",[]).factory("Map",function(){function a(){function a(a,b){for(var c=a.length-1;c>=0;c--)if(a[c].id==b.id)return c;return null}function b(){var a=null,b=9999999;for(var c in e)b>e[c].f_score&&(a=c,b=c.f_score);if(null==a)throw"no node_id";return e[a]}function c(a,b){return Math.abs(a.x-b.x)+Math.abs(a.y-b.y)+Math.abs(a.z-b.z)}function d(a,b){if(-1!=Object.keys(a).indexOf(b.id)){var c=d(a,a[b.id]);return c.concat([b])}return[b]}var e,f=null;this.find=function(g,h,i){f=g;var j=[],k={};for(h.g_score=0,h.f_score=h.g_score+c(h,i),e=[h];e.length>0;){var l=b();if(l.id==i.id)return d(k,i);var m=a(e,l);if(null==m)throw"not found: "+l.id;e.splice(m,1),l.f_score=null,j.push(l);var n=l.getNeighborsOnlyAdjacents();if(0!=n.length)for(var o=n.length-1;o>=0;o--){var p=n[o];if(null==a(j,p)){var q=l.g_score+c(l,p);(null==a(e,p)||q<p.g_score)&&(k[p.id]=l,p.g_score=q,p.f_score=p.g_score+c(p,i),null==a(e,p)&&e.push(p))}}else console.error("no adjs ???")}return[]}}function b(a){switch(a){case-1:return 1;case 0:return 0;case 1:return-1;default:throw"no inverse for "+a}}function c(a,c,d,e,f){this.id=a,this.x=c,this.y=d,this.z=e,this.type=f,this.neighbors=[[[null,null,null],[null,null,null],[null,null,null]],[[null,null,null],[null,null,null],[null,null,null]],[[null,null,null],[null,null,null],[null,null,null]]],this.getNeighbors=function(){for(var a=[],b=-1;1>=b;b++)for(var c=-1;1>=c;c++)for(var d=-1;1>=d;d++)if(0!=b||0!=c||0!=d){var e=this.neighbors[b+1][c+1][d+1];e&&a.push(e)}return a},this.getNeighborsWithoutCorners=function(){for(var a=[],b=-1;1>=b;b++)for(var c=-1;1>=c;c++)for(var d=-1;1>=d;d++)if(!(0==b&&0==c&&0==d||0!=b&&0!=c&&0!=d)){var e=this.neighbors[b+1][c+1][d+1];e&&a.push(e)}return a},this.getNeighborsOnlyAdjacents=function(){var a=[[1,0,0],[0,0,1],[-1,0,0],[0,0,-1],[1,-1,0],[0,-1,1],[-1,-1,0],[0,-1,-1],[1,1,0],[0,1,1],[-1,1,0],[0,1,-1]],b=[];for(var c in a){var d=this.neighbors[a[c][0]+1][a[c][1]+1][a[c][2]+1];d&&b.push(d)}return b},this.removeSelfFromNeighbors=function(){for(var a=-1;1>=a;a++)for(var c=-1;1>=c;c++)for(var d=-1;1>=d;d++)if(0!=a||0!=c||0!=d){var e=this.neighbors[a+1][c+1][d+1];e&&(e.neighbors[b(a)+1][b(c)+1][b(d)+1]=null)}}}function d(){var a=[];this.getByIndex=function(b){for(var c in a)if(a[c].id==b)return c;return null},this.getById=function(b){var c=null;return a.some(function(a){return a.id==b?(c=a,void 0):void 0}),c},this.getByPos=function(b,c,d){var e=null;return a.some(function(a){return a.x==b&&a.y==c&&a.z==d?(e=a,void 0):void 0}),e},this.addCube=function(d){if(!d)throw"no obj?";if(this.getById(d.id))return console.error("cube "+d.id+" already exists in map (by id)"),void 0;if(this.getByPos(d.x,d.y,d.z))return console.error("cube "+d.id+" already exists in map (by pos)"),void 0;for(var e=new c(d.id,d.x,d.y,d.z,d.type),f=-1;1>=f;f++)for(var g=-1;1>=g;g++)for(var h=-1;1>=h;h++)if(0!=f||0!=g||0!=h){var i=this.getByPos(d.x+f,d.y+g,d.z+h);i&&(e.neighbors[f+1][g+1][h+1]=i,i.neighbors[b(f)+1][b(g)+1][b(h)+1]=e)}a.push(e)},this.removeCube=function(b){var c=this.getByIndex(b.id);if(!c)return console.error("map did not find cube by id"),void 0;var d=a[c];d.removeSelfFromNeighbors(),a.splice(c,1)},this.size=function(){return a.length},this.last=function(){return a[a.length-1]},this.first=function(){return a[0]},this.rewind=function(b){var c=a.length;return 0==c?null:(b>=c&&(b=c-1),a[c-1-b])},this.getMap=function(){return a}}var e=new d;return{addCube:function(a){e.addCube(a)},removeCube:function(a){e.removeCube(a)},getCubeByPos:function(a,b,c){return e.getByPos(a,b,c)},getCubeById:function(a){return e.getById(a)},size:function(){return e.size()},newMap:function(){return new d},first:function(){return e.first()},last:function(){return e.last()},newPF:function(){return new a}}}),angular.module("gameApp.services.db",[]).factory("Db",["$rootScope","$location","$timeout",function(a,b,c){function d(a){s=(new Date).getTime();var b=m.child(q.id);b.child("pos").update(a),b.update({date:Firebase.ServerValue.TIMESTAMP})}function e(a){t=(new Date).getTime();var b=m.child(q.id);b.child("rot").update(a),b.update({date:Firebase.ServerValue.TIMESTAMP})}function f(){if(!q)throw"connect called without any user";var a=new Firebase(l.firebaseUrl+"/users/"+q.id+"/connections"),b=new Firebase(l.firebaseUrl+"/users/"+q.id+"/date"),c=new Firebase(l.firebaseUrl+"/.info/connected");c.on("value",function(c){if(c.val()===!0){b.set(Firebase.ServerValue.TIMESTAMP);var d=a.push(!0);d.onDisconnect().remove(),b.onDisconnect().set(Firebase.ServerValue.TIMESTAMP)}})}function g(b){m.once("value",function(c){null!==c.val()&&safeApply(a,function(){b(c.val())})})}function h(b){m.on("child_added",function(c){null!==c.val()&&safeApply(a,function(){b(c.val())})})}function i(a){if(!q)throw"no user!";var b=m.child(q.id).child("inventory").push().name(),c={id:b,type:a.type,display:Objects[a.type].display,path:Objects[a.type].path,date:Firebase.ServerValue.TIMESTAMP};return m.child(q.id).child("inventory").child(b).update(c),a.attrs&&(m.child(q.id).child("inventory").child(b).child("attrs").update(a.attrs),c.attrs=a.attrs),c}function j(a,b,c,d,e,f,g){return d||(d={x:0,y:50,z:0}),e||(e={corps:0,tete:100}),f=f?toArray(f):[],g=g?toArray(g):[],{id:a,name:b,email:c,pos:d,rot:e,inventory:f,robots:g}}function k(b,c,d){safeApply(a,function(){d(b,c.val())})}var l={firebaseUrl:"https://voxelgame.firebaseio.com"},m=new Firebase(l.firebaseUrl+"/users"),n=new Firebase(l.firebaseUrl+"/tchat"),o=new Firebase(l.firebaseUrl+"/cubes"),p=new Firebase(l.firebaseUrl+"/cubelist"),q=null,r=(new Date).getTime(),s=r,t=r,u=1e3,v=null,w=null;a.users=[];var x=new Firebase(l.firebaseUrl+"/.info/serverTimeOffset");return x.on("value",function(a){console.log(a.val()/1e3+"s clock offset")}),h(function(b){a.users.push(b)}),{getUsers:g,getUser:function(){return q},setUser:function(a){q=a,f()},addUser:function(a,b,c){var d=m.push().name(),e={id:d,name:a,email:b,date:Firebase.ServerValue.TIMESTAMP};m.child(d).set(e),c&&c(e)},newUser:j,newPlayer:function(b,c){var d=new Firebase(l.firebaseUrl+"/users/"+b.id);return d.on("value",function(d){safeApply(a,function(){c(b.id,d.val())})}),b},addMessage:function(a,b){var c=n.push().name();n.child(c).set({id:c,name:a,text:b,date:Firebase.ServerValue.TIMESTAMP})},deleteMessage:function(a){n.child(a).remove()},onChatMsg:function(b){n.off("child_added"),n.limit(10).on("child_added",function(c){safeApply(a,function(){b(c.val())})})},onCube:function(a){p.on("child_added",function(b){k("added",b,a)}),p.on("child_changed",function(b){k("changed",b,a)}),p.on("child_removed",function(b){k("removed",b,a)})},put:function(a,b,c,d,e){q&&o.child("pos").child(a).child(b).child(c).once("value",function(f){if(f.val())throw"There is a cube in Db here";var g=p.push().name(),h=(new Date).getTime();o.child("pos").child(a).child(b).child(c).update({id:g,type:d,display:Objects[d].display,path:Objects[d].path,user:q.id,date:h});var i={id:g,type:d,display:Objects[d].display,path:Objects[d].path,user:q.id,date:h,x:a,y:b,z:c};p.child(g).update(i),e&&e(i)})},addInventory:i,removeInventory:function(a){q&&m.child(q.id).child("inventory").child(a).remove()},remove:function(a){q&&p.child(a).once("value",function(b){var c=b.val();if(!c)throw"no cube in Db here";o.child("pos").child(c.x).child(c.y).child(c.z).remove(),p.child(a).remove()})},updatePos:function(a){if(q){var b=(new Date).getTime();if(s>b-u)return c.cancel(v),v=c(function(){d(a)},u-(b-s)),void 0;c.cancel(v),d(a),s=b}},updateRot:function(a){if(q){var b=(new Date).getTime();if(t>b-u)return c.cancel(w),w=c(function(){e(a)},u-(b-t)),void 0;c.cancel(w),e(a),t=b}},addRobot:function(a){if(q){var b=m.child(q.id).child("robots").push().name(),c={id:b,type:a.type,date:Firebase.ServerValue.TIMESTAMP};return m.child(q.id).child("robots").child(b).update(c),a.attrs&&(m.child(q.id).child("robots").child(b).child("attrs").update(a.attrs),c.attrs=a.attrs),c}}}}]),angular.module("gameApp.services.session",[]).factory("Session",["$rootScope","Db",function(a,b){function c(a){var b=null;return e.some(function(c){return c.name==a?(b=c,void 0):void 0}),b}var d=null,e=[],f=null;return b.getUsers(function(a){for(var c in a)e.push(b.newUser(c,a[c].name,a[c].email,a[c].pos,a[c].rot,a[c].inventory,a[c].robots));f&&f(),console.log("Session: "+e.length+" users")}),{onUsersLoad:function(a){f=a,e.length>0&&f&&f()},getUser:function(){return d},isSignedIn:function(){return d?(b.setUser(d),!0):(d=c(readCookie("voxelgame_name")),d&&b.setUser(d),null!=d)},changeLogin:function(a){d=c(a)},login:function(a){d=c(a),d&&(writeCookie("voxelgame_name",d.name,20),b.setUser(d))},signup:function(a,d,f){if(a.error="",0==e.length)return console.log("no users yet"),a.error="waiting for users to load, try again in 2 seconds",void 0;if(!d)return console.log("name is empty"),a.error="name can not be empty",void 0;var g=c(d);return g?(a.error="User already exists",void 0):(g?(a.error="pseudo "+d+" is already taken",a.name=""):(f||(f=""),b.addUser(d,f,function(a){e.push(a)}),a.pwd="enregistré!",writeCookie("voxelgame_name",d,20),a.error=""),void 0)},logout:function(){d=null,writeCookie("voxelgame_name","",20)}}}]),angular.module("gameApp.services.game",[]).factory("Game",["$rootScope","$location","Db","Session","Map",function(a,b,c,d,e){function f(a){var b,c,d=a.lensFlares.length,e=2*-a.positionScreen.x,f=2*-a.positionScreen.y;for(b=0;d>b;b++)c=a.lensFlares[b],c.x=a.positionScreen.x+e*c.distance,c.y=a.positionScreen.y+f*c.distance,c.rotation=0;a.lensFlares[2].y+=.025,a.lensFlares[3].rotation=.5*a.positionScreen.x+THREE.Math.degToRad(45)}function g(a,b,c,d,e,g){var h=new THREE.DirectionalLight(16777215,1);h.color.setHSL(a,b,c),h.position.set(d,e,g),h.castShadow=!0,h.shadowDarkness=.8,B.add(h),h=new THREE.PointLight(16777215,1,0),h.color.setHSL(a,b,c),h.position.set(d,e,g);var i=new THREE.Color(16777215);i.setHSL(a,b,c+.5);var j=new THREE.LensFlare(O,700,0,THREE.AdditiveBlending,i);j.add(P,512,0,THREE.AdditiveBlending),j.add(P,512,0,THREE.AdditiveBlending),j.add(P,512,0,THREE.AdditiveBlending),j.add(Q,60,.6,THREE.AdditiveBlending),j.add(Q,70,.7,THREE.AdditiveBlending),j.add(Q,120,.9,THREE.AdditiveBlending),j.add(Q,70,1,THREE.AdditiveBlending),j.customUpdateCallback=f,j.position=h.position,B.add(j)}function h(){return M.map(function(a){return a.mesh})}function i(){B=new THREE.Scene,B.fog=new THREE.Fog(3355443,300,1e3),F=new THREE.AmbientLight(16777215),F.color.setHSL(.1,.3,.2),B.add(F),g(.995,.5,.9,0,500,300);var a=new THREE.OBJMTLLoader;a.load("obj/female02.obj","obj/female02.mtl",function(a){a.position.x=40,a.position.y=10,a.position.z=-200,a.scale.set(.25,.25,.25),B.add(a)}),Config.modeDebug&&v(),K=new THREEx.RendererStats,K.domElement.style.position="absolute",K.domElement.style.right="0px",K.domElement.style.top="50px",C=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),C.setClearColor(3355443),C.shadowMapEnabled=!0,C.shadowMapSoft=!0,window.addEventListener("resize",r,!1),s(),c.onCube(q),I=!0}function j(a){var b=I;return N=a,J=!1,I||i(),A=$("#game"),r(),A.append(K.domElement),A.append(C.domElement),t(),b}function k(b){N&&safeApply(a,function(){N(b)})}function l(a){for(var b in M)if(M[b].obj&&M[b].obj.id==a.id)return b;return null}function m(a){for(var b in M)if(M[b].obj&&M[b].obj.mesh&&M[b].obj.mesh.position.x==a.position.x&&M[b].obj.mesh.position.y==a.position.y&&M[b].obj.mesh.position.z==a.position.z)return b;return null}function n(a){if(m(a))throw"There is a cube there. Check it before you call addCubeToScene.";var b=new THREE.Mesh(D,Objects[a.type].material);Objects[a.type].opacity&&(b.material.transparent=!0,b.material.opacity=Objects[a.type].opacity),b.position.x=a.x*Config.dimCadri,b.position.y=a.y*Config.dimCadri,b.position.z=a.z*Config.dimCadri,Config.randomCubeRotation&&randomizeRot(b,Config.randomCubeRotationFactor),b.castShadow=!0,b.receiveShadow=!0,B.add(b),M.push({obj:a,mesh:b})}function o(a){B.remove(M[a].mesh),M.splice(a,1)}function p(a){var b=l(a);b?o(b):(console.error("did not find cube"),console.error(a))}function q(a,b){b.date>(new Date).getTime()-1e4&&console.log("cube "+a+" on "+b.x+", "+b.y+", "+b.z),"added"==a?(e.addCube(b),n(b)):"removed"==a?(e.removeCube(b),p(b)):console.error("unknown onCube type "+a)}function r(){E&&(E.camera.aspect=window.innerWidth/window.innerHeight,E.camera.updateProjectionMatrix());var a=window.innerWidth-2*A[0].offsetLeft,b=window.innerHeight-A[0].offsetTop-5;A[0].style.width=a,A[0].style.height=b,C.setSize(a,b)}function s(){function a(a){if(!isLocked){var b=a.movementX||a.mozMovementX||a.webkitMovementX||0,d=a.movementY||a.mozMovementY||a.webkitMovementY||0;E.rotate(b,d),c.updateRot({corps:E.corps.rotation.y,tete:E.tete.rotation.x})}}var b=function(a){if(!isLocked)switch(a.keyCode){case 90:E.moveForward=!0;break;case 81:E.moveLeft=!0;break;case 83:E.moveBackward=!0;break;case 68:E.moveRight=!0;break;case 32:E.jump(!0);break;case 65:E.getCube();break;case 69:E.putCube();break;case 73:E.toggleInventory()}},d=function(a){switch(a.keyCode){case 38:case 90:E.moveForward=!1;break;case 37:case 81:E.moveLeft=!1;break;case 40:case 83:E.moveBackward=!1;break;case 39:case 68:E.moveRight=!1}};document.addEventListener("mousemove",a,!1),document.addEventListener("keydown",b,!1),document.addEventListener("keyup",d,!1),document.addEventListener("mousewheel",function(a){return isLocked?void 0:(E.camdist(a.wheelDelta),!1)},!1),document.addEventListener("mousedown",y,!1),document.addEventListener("mouseup",z,!1)}function t(){J||requestAnimationFrame(t),G=(new Date).getTime(),H=1e3/(G-R),R=G,Config.speedFactor=60/H,K.update(C),E&&(E.updateRobots(),isLocked||(E.move(),E.jump()),C.render(B,E.camera),E.corps.position.y<-150&&u())}function u(){k({text:"You're dead...",delay:5,type:"info"}),E.corps.position.x=0,E.corps.position.y=Config.dimCadri+10,E.corps.position.z=0}function v(){L[0]=new x,B.add(L[0].mesh),L[1]=new x,B.add(L[1].mesh),L[2]=new x,B.add(L[2].mesh)}function w(a){a.pos||(a.pos={x:0,y:Config.dimCadri,z:0}),a.rot||(a.rot={corps:0,tete:0}),this.id=a.id,this.name=a.name,this.onlinePresence=!1,this.corps=new THREE.Object3D,copyVector(this.corps.position,a.pos);var b=[new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body1.jpg"),transparent:!0}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body2.jpg"),transparent:!0}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body3.jpg"),transparent:!0}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body4.jpg"),transparent:!0}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body5.jpg"),transparent:!0}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body6.jpg"),transparent:!0})],c=Config.dimCadri,d=new THREE.CubeGeometry(c,c,c/2);this.torse=new THREE.Mesh(d,new THREE.MeshFaceMaterial(b)),this.corps.add(this.torse),this.torse.castShadow=!0,this.torse.receiveShadow=!0,b=[new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body1.jpg"),transparent:!0}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body2.jpg"),transparent:!0}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/head3.jpg"),transparent:!0}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body4.jpg"),transparent:!0}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/head5.jpg"),transparent:!0}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/head6.jpg"),transparent:!0})];var e=new THREE.CubeGeometry(c/2,c/2,c/2);this.tete=new THREE.Mesh(e,new THREE.MeshFaceMaterial(b)),this.tete.castShadow=!0,this.tete.receiveShadow=!0,this.tete.position.y=c,this.tete.position.z=-c/4,this.corps.add(this.tete);var f=new THREE.TextGeometry(a.name,{font:"optimer",weight:"normal",style:"normal",size:4,height:.5,curveSegments:2,bevelThickness:.1,bevelSize:.1,bevelEnabled:!0}),g=new THREE.MeshPhongMaterial({color:16755200,transparent:!0});this.name_label=new THREE.Mesh(f,g);var h=new THREE.Box3;return h.setFromObject(this.name_label),this.name_label.position.y=.25*c,this.name_label.position.z=.25*c,this.name_label.position.x=-(h.max.x-h.min.x)/2,this.corps.add(this.name_label),copyRotation(this,a.rot),B.add(this.corps),M.push({mesh:this.torse}),this.updateOnlinePresence=function(a){if(this.onlinePresence=a,a){for(var b=this.torse.material.materials.length-1;b>=0;b--)this.torse.material.materials[b].opacity=1;for(var b=this.tete.material.materials.length-1;b>=0;b--)this.tete.material.materials[b].opacity=1;this.tete.castShadow=!0,this.tete.receiveShadow=!0,this.torse.castShadow=!0,this.torse.receiveShadow=!0}else{for(var c=.4,b=this.torse.material.materials.length-1;b>=0;b--)this.torse.material.materials[b].opacity=c;for(var b=this.tete.material.materials.length-1;b>=0;b--)this.tete.material.materials[b].opacity=c;this.name_label.material.opacity=.4,this.tete.castShadow=!1,this.tete.receiveShadow=!1,this.torse.castShadow=!1,this.torse.receiveShadow=!1}},this.move=function(a,b){copyVector(this.corps.position,a),copyRotation(this,b)},this}function x(){this.mesh=new THREE.BoxHelper,this.mesh.scale.set(Config.dimCadri/2,Config.dimCadri/2,Config.dimCadri/2),this.mesh.visible=!1}function y(a){if(!isLocked){switch(a.button){case 0:E.dummy.mesh.material.color.setRGB(1,0,0);break;case 1:break;case 2:E.dummy.mesh.material.color.setRGB(0,1,0)}E.dummy.mesh.visible=!0}}function z(a){if(!isLocked)switch(E.dummy.mesh.visible=!1,a.button){case 0:E.getCube();break;case 1:break;case 2:E.putCube()}}var A,B,C,D,E,F,G,H,I=!1,J=!0,K=null,L=[],D=new THREE.CubeGeometry(Config.dimCadri,Config.dimCadri,Config.dimCadri),M=[],N=null,O=THREE.ImageUtils.loadTexture("images/lensflare0.png"),P=THREE.ImageUtils.loadTexture("images/lensflare2.png"),Q=THREE.ImageUtils.loadTexture("images/lensflare3.png"),R=(new Date).getTime();return{init:function(a){return j(a)},stop:function(){J||console.log("Game rendering has been stopped but still receive DB updates"),J=!0},addMainPlayer:function(a){E=a,B.add(E.corps),E.robots.forEach(function(a){B.add(a.body)})},getMainPlayer:function(){return E},addRobot:function(a){B.add(a.body)},addPNJ:function(a){return new w(a)},getObjects:function(){return M},getMeshObjects:function(){return h()},addCubeToScene:function(a){n(a)},removeCubeFromScene:function(a){p(a)},removeCubeFromSceneByKey:function(a){o(a)},addGetPutDummy:function(){var a=new x;return B.add(a.mesh),a},addMessage:function(a){k(a)},getCubeFromSceneById:function(a){var b=l(a);return b?M[b]:null}}}]),angular.module("gameApp.services.mainplayer",[]).factory("MainPlayer",["$rootScope","$location","Db","Session","Game","Robot","Map",function(a,b,c,d,e,f){function g(b,d){function g(a){var c=null;return b.inventory.some(function(b){return b.id==a?(c=b,void 0):void 0}),c}function h(a){var c=b.inventory;for(var d in c)if(c[d].id==a)return d;return null}function i(){b.inventory&&b.inventory.sort(function(a,b){return a.display<b.display?-1:1})}function j(a){var b=e.getMeshObjects();for(var c in b)if(b[c].position.x==a.x&&b[c].position.y==a.y&&b[c].position.z==a.z)return c;return null}function k(a){if(0==b.inventory.length)l=null;else{for(a||(a=0);a>=b.inventory.length;)a--;l=b.inventory[a],d.updateInventoryCallback(b.inventory,l)}}this.dbUser=b;var l=null;i(),k(0);var m=(b.id,new THREE.Vector3(b.pos.x,b.pos.y,b.pos.z));this.dummy=e.addGetPutDummy();var n=Config.distCamPlayer,o=.66*Config.dimCadri,p=document.createElement("audio"),q=document.createElement("source");q.src="sounds/ammo_bounce.wav",p.appendChild(q),p.play(),this.name=name;var r=!0,s=0;this.jumping=!1,this.corps=new THREE.Object3D,this.corps.position.copy(b.pos);var t=[new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body1.jpg")}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body2.jpg")}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body3.jpg")}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body4.jpg")}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body5.jpg")}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body6.jpg")})],u=Config.dimCadri,v=new THREE.CubeGeometry(u,u,u/2);this.torse=new THREE.Mesh(v,new THREE.MeshFaceMaterial(t)),this.torse.castShadow=!0,this.torse.receiveShadow=!0,this.corps.add(this.torse);var t=[new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body1.jpg")}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body2.jpg")}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body3.jpg")}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body4.jpg")}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/head5.jpg")}),new THREE.MeshLambertMaterial({ambient:16777215,map:THREE.ImageUtils.loadTexture("images/body6.jpg")})],w=new THREE.CubeGeometry(u/2,u/2,u/2);this.tete=new THREE.Mesh(w,new THREE.MeshFaceMaterial(t)),this.tete.castShadow=!0,this.tete.receiveShadow=!0,this.tete.position.y=u,this.tete.position.z=-u/4,this.corps.add(this.tete),this.camera=new THREE.PerspectiveCamera(Config.viewwAngle,window.innerWidth/window.innerHeight,1,1e3),this.camera.position.x+=Math.sin(this.corps.rotation.y)*n,this.camera.position.z+=Math.cos(this.corps.rotation.y)*n,this.tete.add(this.camera),this.corps.rotation.y=b.rot.corps,this.tete.rotation.x=b.rot.tete,this.robots=[];for(var x=0;x<b.robots.length;x++)this.robots.push(new f.newRobot(b.robots[x],this,{}));d.updateRobots(this.robots),this.updateRobots=function(){this.robots.forEach(function(a){a.update()})},this.updateCamera=function(){this.camera.position.x+=(this.tete.position.x-this.camera.position.x)/10,this.camera.position.y+=(this.tete.position.y-this.camera.position.y-Config.dimCadri/2)/10},this.rotate=function(a,b){this.corps.rotation.y-=.002*a,this.tete.rotation.x-=.002*b,this.tete.rotation.x>Math.PI/2&&(this.tete.rotation.x=Math.PI/2),this.tete.rotation.x<-Math.PI/2&&(this.tete.rotation.x=-Math.PI/2)},this.move=function(){var a=this.canMove();if(a&&(0!=a.x||0!=a.z)){m.copy(this.corps.position),m.x+=a.x*Config.playerSpeed*Config.speedFactor,m.z+=a.z*Config.playerSpeed*Config.speedFactor,this.corps.position.copy(m);var b={x:m.x,y:m.y,z:m.z};if(c.updatePos(b),Config.randomCubeRotation&&!this.jumping){var d={rotation:{x:0,y:0,z:0}};randomizeRot(d,.02),copyVector(this.torse.rotation,d.rotation)}}},this.canMove=function(){var a=[],b=[],c=Math.PI/4;a[0]=0,b[0]=0,a[1]=0,b[1]=0,a[2]=0,b[2]=0,this.moveForward&&(a[0]-=Math.sin(this.corps.rotation.y-c),b[0]-=Math.cos(this.corps.rotation.y-c),a[1]-=Math.sin(this.corps.rotation.y),b[1]-=Math.cos(this.corps.rotation.y),a[2]-=Math.sin(this.corps.rotation.y+c),b[2]-=Math.cos(this.corps.rotation.y+c)),this.moveBackward&&(a[0]+=Math.sin(this.corps.rotation.y-c),b[0]+=Math.cos(this.corps.rotation.y-c),a[1]+=Math.sin(this.corps.rotation.y),b[1]+=Math.cos(this.corps.rotation.y),a[2]+=Math.sin(this.corps.rotation.y+c),b[2]+=Math.cos(this.corps.rotation.y+c)),this.moveLeft&&(a[0]-=Math.sin(this.corps.rotation.y+Math.PI/2-c),b[0]-=Math.cos(this.corps.rotation.y+Math.PI/2-c),a[1]-=Math.sin(this.corps.rotation.y+Math.PI/2),b[1]-=Math.cos(this.corps.rotation.y+Math.PI/2),a[2]-=Math.sin(this.corps.rotation.y+Math.PI/2+c),b[2]-=Math.cos(this.corps.rotation.y+Math.PI/2+c)),this.moveRight&&(a[0]-=Math.sin(this.corps.rotation.y-Math.PI/2-c),b[0]-=Math.cos(this.corps.rotation.y-Math.PI/2-c),a[1]-=Math.sin(this.corps.rotation.y-Math.PI/2),b[1]-=Math.cos(this.corps.rotation.y-Math.PI/2),a[2]-=Math.sin(this.corps.rotation.y-Math.PI/2+c),b[2]-=Math.cos(this.corps.rotation.y-Math.PI/2+c));for(var d={x:a[1],z:b[1]},f=e.getMeshObjects(),g=0;3>g;g++){var h=new THREE.Raycaster(this.corps.position,new THREE.Vector3(a[g]*o,0,b[g]*o).normalize()),i=h.intersectObjects(f);i.length>0&&i[0].distance<o&&(p.play(),d=!1)}var j=Config.dimCadri+5;return this.dummy.mesh.position.y=Math.round((this.corps.position.y+Math.sin(this.tete.rotation.x)*j+Config.dimCadri/2)/Config.dimCadri)*Config.dimCadri,this.dummy.mesh.position.x=Math.round((this.corps.position.x-Math.sin(this.corps.rotation.y)*j*Math.cos(this.tete.rotation.x))/Config.dimCadri)*Config.dimCadri,this.dummy.mesh.position.z=Math.round((this.corps.position.z-Math.cos(this.corps.rotation.y)*j*Math.cos(this.tete.rotation.x))/Config.dimCadri)*Config.dimCadri,d},this.jump=function(a){a&&(this.jumping=!0),r&&1==this.jumping&&(r=!1,s=6);var b=!0,c=new THREE.Raycaster(this.corps.position,new THREE.Vector3(0,-1,0)),d=c.intersectObjects(e.getMeshObjects());d.length>0&&d[0].distance<o&&(b=!1),0>s&&(this.jumping=!1),b||1==this.jumping?(s>-5&&(s-=.2*Config.speedFactor),this.corps.position.y+=s):(0>s&&(s=0),r=!0,this.jumping=!1)},this.toggleInventory=function(){d.toggleInventoryCallback&&d.updateInventoryCallback&&safeApply(a,function(){d.updateInventoryCallback(b.inventory,l),d.toggleInventoryCallback()})},this.getCube=function(){if(b.inventory.length>=Config.maxInventory)return e.addMessage({text:"Too many objects in inventory",delay:5,type:"error"}),void 0;var a=this.canGet();if(a){var f=e.getObjects()[a].obj;c.remove(f.id);var f=c.addInventory({type:f.type});b.inventory.push(f),i(),l=f,d.updateInventoryCallback(b.inventory,f),e.addMessage({text:"ok, in inventory",delay:3,type:"info"})}else e.addMessage({text:"No cube here !",delay:3,type:"error"})},this.canGet=function(){return j(this.dummy.mesh.position)},this.putCube=function(){var a=this.canGet();if(a)return e.addMessage({text:"There is a cube there",delay:2,type:"error"}),void 0;if(!l)return e.addMessage({text:"Nothing in hand!",delay:2,type:"error"}),void 0;var f={x:this.dummy.mesh.position.x/Config.dimCadri,y:this.dummy.mesh.position.y/Config.dimCadri,z:this.dummy.mesh.position.z/Config.dimCadri};c.put(f.x,f.y,f.z,l.type),c.removeInventory(l.id);var g=h(l.id);b.inventory.splice(g,1),d.updateInventoryCallback(b.inventory),k(g)},this.setCamDist=function(a){var b=5,c=a;b>c&&(c=b),this.camera.position.x=this.tete.position.x+Math.sin(this.tete.rotation.y)*c,this.camera.position.z=this.tete.position.z+Math.cos(this.tete.rotation.y)*c,b>a?(this.camera.fov=Config.viewAngle-a/1.5,this.camera.updateProjectionMatrix()):this.camera.fov!=Config.viewAngle&&(this.camera.fov=Config.viewAngle,this.camera.updateProjectionMatrix())},this.camdist=function(a){n-=a/10,-60>n&&(n=-60),this.setCamDist(n)},this.setCamDist(Config.distCamPlayer),this.setSelectedObject=function(a){l=g(a.id)},this.createRobot=function(){var a=c.addRobot({type:"holefiller"}),b=new f.newRobot(a,this,{});this.robots.push(b),e.addRobot(b)}}return{newPlayer:function(a,b){return g=new g(a,b)}}}]),angular.module("gameApp.services.robot",[]).factory("Robot",["$rootScope","$location","Db","Game","Map",function(a,b,c,d,e){function f(a,b){function c(a,b){return Math.abs(a)<b&&(0>a?a+=n:a-=n),a}function d(a){for(var b;b=a.pop();)if(!f.getById(b.id)&&null==e.getCubeById(b.id).neighbors[1][2][1])return b;return null}this.dbRobot=a,a.pos||(a.pos={x:b.corps.position.x,y:b.corps.position.y,z:b.corps.position.z}),a.rot||(a.rot={body:b.corps.rotation.y}),this.active=!0;var f=e.newMap(),g=e.newPF(),h=[],i=null;this.body=new THREE.Object3D,this.body.position.copy(a.pos);var j=({x:Math.floor(this.body.position.x/Config.dimCadri),y:Math.floor(this.body.position.y/Config.dimCadri),z:Math.floor(this.body.position.z/Config.dimCadri)},THREE.ImageUtils.loadTexture("images/ash_uvgrid01.jpg"));j.wrapS=j.wrapT=THREE.RepeatWrapping,j.anisotropy=16;var k=new THREE.MeshLambertMaterial({ambient:16777215,map:j}),l=Config.dimCadri/2,m=new THREE.CubeGeometry(l,l,l);this.torso=new THREE.Mesh(m,k),this.torso.castShadow=!0,this.torso.receiveShadow=!0,this.body.add(this.torso),this.update=function(){this.active&&this.explore()};var n=30;this.goTo=function(a,b){var d=a.x-this.body.position.x,e=a.z-this.body.position.z;d=c(d,b),e=c(e,b);var f=a.y-this.body.position.y;return f>5?(this.body.position.y+=f/(n/Config.speedFactor),void 0):d>5||e>5?(this.body.position.x+=d/(n/Config.speedFactor),this.body.position.z+=e/(n/Config.speedFactor),void 0):(this.body.position.y+=f/(n/Config.speedFactor),this.body.position.x+=d/(n/Config.speedFactor),this.body.position.z+=e/(n/Config.speedFactor),void 0)},this.moveTowardsPlayer=function(){this.goTo(b.corps.position,2*Config.dimCadri)},this.distanceFromPlayer=function(){var a=this.body.position,c=b.corps.position,d=Math.sqrt(Math.pow(a.x-c.x,2)+Math.pow(a.y-c.y,2)+Math.pow(a.z-c.z,2));return Math.round(d/Config.dimCadri)},this.printPos=function(){var a=this.getCurrentPosCubePos();return"("+a.x+","+a.y+","+a.z+")"},this.getCurrentPosCubePos=function(){return{x:Math.round(this.body.position.x/Config.dimCadri),y:Math.round(this.body.position.y/Config.dimCadri),z:Math.round(this.body.position.z/Config.dimCadri)}},this.getRealCubeByCurrentPos=function(){var a=this.getCurrentPosCubePos();return e.getCubeByPos(a.x,a.y-1,a.z)};var o=0;this.getNextUnchartedCube=function(){if(0==f.size()){var a=this.getRealCubeByCurrentPos();return a||(a=e.first()),a}var b=this.getCurrentPosCubePos(),a=e.getCubeById(f.getByPos(b.x,b.y-1,b.z).id),c=a.getNeighborsOnlyAdjacents(),i=d(c);if(i)return i;for(o=1;o<f.size()&&(i=e.getCubeById(f.rewind(o).id))&&!d(i.getNeighborsOnlyAdjacents());)o+=1;if(o==f.size()&&(this.active=!1,console.log("All neighbors in memory!")),h=g.find(f,a,f.rewind(o)),0==h.length)throw"no path to cube ??? rewind="+o+", memory len="+f.size();return h[0]};var p=null;this.explore=function(){if(p){var a=this.getCurrentPosCubePos();return a.x==p.x&&a.y-1==p.y&&a.z==p.z?(p=null,void 0):(this.goTo({x:p.x*Config.dimCadri,y:(p.y+1)*Config.dimCadri,z:p.z*Config.dimCadri},0),void 0)}if(h.length>0?(p=h[0],h.splice(0,1)):p=this.getNextUnchartedCube(),!p)return console.log("no cube to go"),void 0;f.getById(p.id)||(f.addCube(p),o=0);var b=f.size();b!=i&&(i=b)}}return{newRobot:function(a,b,c){return new f(a,b,c)}}}]),angular.module("gameApp.services.notification",[]).factory("Notification",["$rootScope",function(){return{types:{CHAT:{title:"Jethro koull",icon:"http://www.cusi.fr/site/tchat-enfant/im/msn.jpg"}},enable:function(){"undefined"!=typeof webkitNotifications&&0!=webkitNotifications.checkPermission()&&(console.log("no notification permissions"),webkitNotifications.requestPermission())},add:function(a,b){if("undefined"!=typeof webkitNotifications)try{webkitNotifications.createNotification(a.icon,a.title,b).show()}catch(c){console.log(c.message)}}}}]),Date.prototype.getWeek=function(){var a=new Date(this.getFullYear(),0,1);return Math.ceil(((this-a)/864e5+a.getDay()+1)/7)},angular.module("gameApp").controller("MainCtrl",["$rootScope","$scope","$location","$timeout","Db","Session","Notification","Game",function(a,b,c,d,e,f,g,h){function i(){a.isSignedIn=f.isSignedIn();var c=f.getUser();c&&(b.name=c.name)}function j(a){var c=$.map(b.chat_messages,function(b,c){return b.id==a?c:void 0});return c[0]
}a.current_date=(new Date).getTime(),a.weekNumber=(new Date).getWeek(),b.chat_messages=[],g.enable(),console.log("main"),h.stop(),i(),f.onUsersLoad(i),e.onChatMsg(function(a){b.chat_messages.push(a),h.addMessage({text:a.name+": "+a.text,delay:10,type:"chat"}),a.date>(new Date).getTime()-5e3&&g.add(g.types.CHAT,a.name+": "+a.text)}),b.login=function(){f.login(b.name,b.pwd),a.isSignedIn=f.isSignedIn()},b.test=function(){console.log("ok")},b.signup=function(){f.signup(b,b.name,b.email,b.pwd),a.isSignedIn=f.isSignedIn()},a.logout=function(){f.logout(),a.isSignedIn=!1},b.addMsg=function(a,c){c&&(e.addMessage(a,c),b.msg="")},b.deleteMsg=function(a){var c=j(a);e.deleteMessage(a),b.chat_messages.splice(c,1)}}]),angular.module("gameApp").controller("GameCtrl",["$rootScope","$scope","$timeout","$location","Db","Game","Session","MainPlayer",function(a,b,c,d,e,f,g,h){function i(){b.dummy=1,c(function(){i()},1e3)}function j(a){var b=null;return v.some(function(c){return c.id==a?(b=c,void 0):void 0}),b}function k(a,b){var c=j(a);if(c){c.move(b.pos,b.rot);var d=null!=b.connections;c.onlinePresence!=d&&f.addMessage({text:c.name+" is now "+(d?"online":"offline"),delay:10,type:d?"info":"error"}),c.updateOnlinePresence(d)}}function l(a){b.pos=a.pos}function m(){b.showInventory=!b.showInventory,console.log("toggle "+b.showInventory)}function n(a,c){console.log("update"),b.inventory=a,b.selectedInventoryObject=c}function o(a){b.robots=a}function p(a){a=a?1e3*a:4e3,c(function(){b.msgs.splice(0,1),0==b.msgs.length?b.showConsole=!1:p(b.msgs[0].delay)},a)}function q(a){b.msgs.push(a),b.showConsole=!0,1==b.msgs.length&&p(a.delay)}var r=g.getUser();if(!r)return d.path("/"),void 0;b.showInventory=!1,b.showConsole=!1,b.msgs=[];var s=null,t=f.init(q);if(t)console.log("Game was already initialized"),s=f.getMainPlayer(),o(s.robots),n(s.dbUser.inventory);else{s=h.newPlayer(r,{playerUpdateCallback:l,toggleInventoryCallback:m,updateInventoryCallback:n,updateRobots:o}),f.addMainPlayer(s);var u=a.users,v=[];for(var w in u)if(u[w].id!=r.id){var x=e.newPlayer(u[w],k),y=f.addPNJ(x);y.updateOnlinePresence(!1),v.push(y)}console.log(v.length+" pnjs")}$("#instructions").click(function(){enablePointerLock()}),c(function(){f.addMessage({text:"Welcome !",type:"system",delay:4})},4e3),c(function(){f.addMessage({text:"La position des autres joueurs n'est pas mise à jour en temps réel. C'est normal pour l'instant. Ce n'est pas du lag :)",type:"system",delay:7})},6e3),i(),b.createRobot=function(){s.createRobot()},b.selectInventory=function(a){b.selectedInventoryObject==a.id?(b.selectedInventoryObject=null,s.setSelectedObject(null)):(b.selectedInventoryObject=a,s.setSelectedObject(a))}}]),angular.module("gameApp").controller("UsersCtrl",["$scope","Db",function(){}]),angular.module("gameApp").controller("HeaderCtrl",["$scope","$location",function(a,b){a.isActive=function(a){return a===b.path()}}]);