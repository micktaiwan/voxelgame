"use strict";angular.module("gameApp",["ngCookies","ngResource","ngSanitize","gameApp.services.db","gameApp.services.session","gameApp.services.game"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/game",{templateUrl:"views/game.html",controller:"GameCtrl"}).when("/users",{templateUrl:"views/users.html",controller:"UsersCtrl"}).when("/about",{templateUrl:"views/about.html"}).otherwise({redirectTo:"/"})}]),Date.prototype.getWeek=function(){var a=new Date(this.getFullYear(),0,1);return Math.ceil(((this-a)/864e5+a.getDay()+1)/7)},angular.module("gameApp").controller("MainCtrl",["$rootScope","$scope","$location","$timeout","Db","Session",function(a,b,c,d,e,f){function g(){b.isSignedIn=f.isSignedIn();var a=f.getUser();a&&(b.name=a.name)}b.current_date=(new Date).getTime(),b.weekNumber=(new Date).getWeek(),g(),f.onUsersLoad(g),b.login=function(){f.login(b.name,b.pwd),b.isSignedIn=f.isSignedIn()},b.signup=function(){f.signup(b,b.name,b.email,b.pwd),b.isSignedIn=f.isSignedIn()},b.logout=function(){f.logout(),b.isSignedIn=!1},e.getTchat(function(a,b){$("<div/>").text(b).prepend($("<em/>").text(a+": ")).appendTo($("#messagesDiv")),$("#messagesDiv")[0].scrollTop=$("#messagesDiv")[0].scrollHeight}),b.addMsg=function(a,c){e.addMessage(a,c),b.msg=""}}]),angular.module("gameApp").controller("GameCtrl",["$rootScope","$scope","$timeout","$location","Db","Game","Session",function(a,b,c,d,e,f,g){function h(a){var b=null;return m.some(function(c){return c.id==a?(b=c,void 0):void 0}),b}function i(a,b){var c=h(a);c&&c.move(b.pos,b.rot)}var j=g.getUser();if(!j)return d.path("/"),void 0;var k=f.addMainPlayer(j.name,j.pos);f.init(k);var l=a.users,m=[];for(var n in l)if(l[n].id!=j.id){var k=e.newPlayer(l[n].id,l[n].name,l[n].pos,l[n].rot,i);m.push(f.addPNJ(k.id,k.name,k.pos,k.rot))}console.log(m.length+" pnjs"),f.animate(),$("#instructions").click(function(){enablePointerLock()})}]),angular.module("gameApp").controller("UsersCtrl",["$scope","Db",function(){}]),angular.module("gameApp").controller("HeaderCtrl",["$scope","$location",function(a,b){a.isActive=function(a){return a===b.path()}}]),angular.module("gameApp.services.db",[]).factory("Db",["$rootScope","$location",function(a){function b(a,b){a.$$phase||a.$root.$$phase?b():a.$apply(b)}function c(c){g.once("value",function(d){null!==d.val()&&b(a,function(){c(d.val())})})}function d(c){g.on("child_added",function(d){null!==d.val()&&b(a,function(){c(d.val())})})}function e(a,b,c,d,e){return{id:a,name:b,email:c,pos:d,rot:e}}var f={firebaseUrl:"https://voxelgame.firebaseio.com"},g=new Firebase(f.firebaseUrl+"/users"),h=new Firebase(f.firebaseUrl+"/tchat"),i=new Firebase(f.firebaseUrl+"/cubes"),j=null;return a.users=[],d(function(b){a.users.push(b)}),{getUsers:c,getUser:function(){return j},setUser:function(a){j=a},addUser:function(a,b){var c=g.push().name();g.child(c).set({id:c,name:a,email:b})},newUser:e,newPlayer:function(c,d,e,g,h){var i=new Firebase(f.firebaseUrl+"/users/"+c);return i.on("value",function(d){b(a,function(){h(c,d.val())})}),{id:c,name:d,pos:e,rot:g}},addMessage:function(a,b){h.push({name:a,text:b})},getTchat:function(a){h.on("child_added",function(b){var c=b.val();a(c.name,c.text)})},onNewCube:function(a){i.on("child_added",function(b){var c,d,e,f,g=b.val();for(c in g)for(d in g[c])for(e in g[c][d])f=g[c][d][e].type,a(c,d,e,f)})},put:function(a,b,c,d){j&&i.child("pos").child(a).child(b).child(c).update({type:d,user:j.id,date:(new Date).getTime()})},remove:function(a,b,c){j&&i.child("pos").child(a).child(b).child(c).remove()},updatePos:function(a){if(j){var b=g.child(j.id);b.child("pos").update(a),b.update({date:(new Date).getTime()})}},updateRot:function(a){if(j){var b=g.child(j.id);b.child("rot").update(a),b.update({date:(new Date).getTime()})}}}}]),angular.module("gameApp.services.session",[]).factory("Session",["$rootScope","Db",function(a,b){function c(a){var b=null;return e.some(function(c){return c.name==a?(b=c,void 0):void 0}),b}var d=null,e=[],f=null;return b.getUsers(function(a){for(var c in a)e.push(b.newUser(c,a[c].name,a[c].email,a[c].pos,a[c].rot));f&&f(),console.log("Session: "+e.length+" users")}),{onUsersLoad:function(a){f=a},getUser:function(){return d},isSignedIn:function(){return d?(b.setUser(d),!0):(d=c(readCookie("voxelgame_name")),d&&b.setUser(d),null!=d)},changeLogin:function(a){d=c(a)},login:function(a){d=c(a),d&&(writeCookie("voxelgame_name",d.name,20),b.setUser(d)),console.log(d)},signup:function(e,f){return e.error="",a.users?(d=c(f))?(e.error="User already exists",void 0):(d?(e.error="pseudo "+f+" is already taken",e.name=""):(email||(email=""),b.addUser(f,email),e.pwd="enregistr√©!",writeCookie("voxelgame_name",f,20),e.error=""),void 0):(e.error="waiting for users to load",void 0)},logout:function(){d=null,writeCookie("voxelgame_name","",20)}}}]),angular.module("gameApp.services.game",[]).factory("Game",["$rootScope","$location","Db",function(a,b,c){function d(a,b){a.x=b.x,a.y=b.y,a.z=b.z}function e(a,b){a.corps.rotation.y=b.corps,a.tete.rotation.x=b.tete}function f(a){v=a,s=new THREE.Scene,s.fog=new THREE.Fog(4473924,0,600),w=new THREE.DirectionalLight(10066312,1.5),w.position.set(1,1,1),s.add(w),w=new THREE.DirectionalLight(16776960,1.5),w.position.set(-1,-1,-1),s.add(w),x=new THREE.PointLight(16777215,2,50),x.position.set(-1,1,-1),s.add(x),s.add(v.corps),B[10]=new o,s.add(B[10].mesh),l&&l(),t=new THREE.WebGLRenderer,t.setClearColor(4487031),r=$("#game"),h(),r.append(t.domElement),window.addEventListener("resize",h,!1),i(),c.onNewCube(g)}function g(a,b,c){var d=new THREE.Mesh(u,C);d.position.x=a,d.position.y=b,d.position.z=c,s.add(d),D.push(d)}function h(){v.camera.aspect=window.innerWidth/window.innerHeight,v.camera.updateProjectionMatrix();var a=window.innerWidth-2*r[0].offsetLeft,b=window.innerHeight-2*r[0].offsetTop;t.setSize(a,b),r[0].style.width=a,r[0].style.height=b}function i(){var a=function(a){var b=a.movementX||a.mozMovementX||a.webkitMovementX||0,d=a.movementY||a.mozMovementY||a.webkitMovementY||0;v.corps.rotation.y-=.002*b,v.tete.rotation.x-=.002*d,v.camera.position.x+=.01*b,v.camera.position.y-=.01*d,v.tete.rotation.x<-E/2&&(v.tete.rotation.x=-E/2),v.tete.rotation.x>E/2&&(v.tete.rotation.x=E/2),c.updateRot({corps:v.corps.rotation.y,tete:v.tete.rotation.x})},b=function(a){switch(a.keyCode){case 90:v.moveForward=!0;break;case 81:v.moveLeft=!0;break;case 83:v.moveBackward=!0;break;case 68:v.moveRight=!0;break;case 32:v.jumping=!0,v.jump();break;case 69:v.getCube();break;case 82:v.putCube()}},d=function(a){switch(a.keyCode){case 38:case 87:case 90:v.moveForward=!1;break;case 37:case 65:case 81:v.moveLeft=!1;break;case 40:case 83:v.moveBackward=!1;break;case 39:case 68:v.moveRight=!1}};document.addEventListener("mousemove",a,!1),document.addEventListener("keydown",b,!1),document.addEventListener("keyup",d,!1),document.addEventListener("mousewheel",function(a){return v.camdist(a.wheelDelta),!1},!1),document.addEventListener("mousedown",p,!1)}function j(){requestAnimationFrame(j),q.update(t),v&&(v.updateCamera(),isLocked&&(v.move(),v.jump(),x.position.set(v.corps.position.x,v.corps.position.y,v.corps.position.z)),t.render(s,v.camera),v.corps.position.y<-150&&k())}function k(){v.corps.position.x=0,v.corps.position.y=30,v.corps.position.z=0}function l(){B[0]=new o,s.add(B[0].mesh),B[1]=new o,s.add(B[1].mesh),B[2]=new o,s.add(B[2].mesh)}function m(a,b){var d=8,e=document.createElement("audio"),f=document.createElement("source");f.src="sounds/ammo_bounce.wav",e.appendChild(f),e.play();var g=!0,h=0,i=new THREE.Vector3(b.x,b.y,b.z);this.name=a,this.jumping=!1,this.corps=new THREE.Object3D,this.corps.position.copy(b);var j=THREE.ImageUtils.loadTexture("images/ash_uvgrid01.jpg");j.wrapS=j.wrapT=THREE.RepeatWrapping,j.anisotropy=16;var k=new THREE.MeshLambertMaterial({ambient:12303291,map:j}),m=new THREE.CubeGeometry(z/2,z/2,z/2);this.torse=new THREE.Mesh(m,k),this.corps.add(this.torse);var n=new THREE.CubeGeometry(z/4,z/4,z/4);this.tete=new THREE.Mesh(n,k),this.tete.position.y=z/2,this.tete.position.z=-5,this.corps.add(this.tete),this.camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,1,1e3),this.camera.position.x+=Math.sin(this.corps.rotation.y)*A,this.camera.position.z+=Math.cos(this.corps.rotation.y)*A,this.tete.add(this.camera),this.updateCamera=function(){this.camera.position.x+=(this.tete.position.x-this.camera.position.x)/10,this.camera.position.y+=(this.tete.position.y-this.camera.position.y-z/2)/10},this.move=function(){i.copy(this.corps.position);var a=this.canMove();a&&(i.x+=a[0],i.z+=a[1],this.corps.position.copy(i),c.updatePos({x:i.x,y:i.y,z:i.z}))},this.canMove=function(){var a=[],b=[],c=E/4;a[0]=0,b[0]=0,a[1]=0,b[1]=0,a[2]=0,b[2]=0,this.moveForward&&(a[0]-=Math.sin(this.corps.rotation.y-c),b[0]-=Math.cos(this.corps.rotation.y-c),a[1]-=Math.sin(this.corps.rotation.y),b[1]-=Math.cos(this.corps.rotation.y),a[2]-=Math.sin(this.corps.rotation.y+c),b[2]-=Math.cos(this.corps.rotation.y+c)),this.moveBackward&&(a[0]+=Math.sin(this.corps.rotation.y-c),b[0]+=Math.cos(this.corps.rotation.y-c),a[1]+=Math.sin(this.corps.rotation.y),b[1]+=Math.cos(this.corps.rotation.y),a[2]+=Math.sin(this.corps.rotation.y+c),b[2]+=Math.cos(this.corps.rotation.y+c)),this.moveLeft&&(a[0]-=Math.sin(this.corps.rotation.y+E/2-c),b[0]-=Math.cos(this.corps.rotation.y+E/2-c),a[1]-=Math.sin(this.corps.rotation.y+E/2),b[1]-=Math.cos(this.corps.rotation.y+E/2),a[2]-=Math.sin(this.corps.rotation.y+E/2+c),b[2]-=Math.cos(this.corps.rotation.y+E/2+c)),this.moveRight&&(a[0]-=Math.sin(this.corps.rotation.y-E/2-c),b[0]-=Math.cos(this.corps.rotation.y-E/2-c),a[1]-=Math.sin(this.corps.rotation.y-E/2),b[1]-=Math.cos(this.corps.rotation.y-E/2),a[2]-=Math.sin(this.corps.rotation.y-E/2+c),b[2]-=Math.cos(this.corps.rotation.y-E/2+c));for(var f=[a[1],b[1]],g=0;3>g;g++){var h=new THREE.Raycaster(this.corps.position,new THREE.Vector3(a[g]*d,0,b[g]*d).normalize()),i=h.intersectObjects(D);i.length>0&&i[0].distance<d&&(e.play(),f=!1),l&&(B[g].mesh.position.y=this.corps.position.y,B[g].mesh.position.x=this.corps.position.x+a[g]*d,B[g].mesh.position.z=this.corps.position.z+b[g]*d)}var j=25;return B[10].mesh.position.y=Math.round((this.corps.position.y+Math.sin(this.tete.rotation.x)*j+z/2)/z)*z,B[10].mesh.position.x=Math.round((this.corps.position.x-Math.sin(this.corps.rotation.y)*j*Math.cos(this.tete.rotation.x))/z)*z,B[10].mesh.position.z=Math.round((this.corps.position.z-Math.cos(this.corps.rotation.y)*j*Math.cos(this.tete.rotation.x))/z)*z,f},this.jump=function(){g&&1==this.jumping&&(g=!1,h=4.3);var a=!0,b=new THREE.Raycaster(this.corps.position,new THREE.Vector3(0,-1,0)),c=b.intersectObjects(D);c.length>0&&c[0].distance<d&&(a=!1),0>h&&(this.jumping=!1),a||1==this.jumping?(h>-5&&(h-=.2),this.corps.position.y+=h):(0>h&&(h=0),g=!0,this.jumping=!1)},this.getCube=function(){var a=this.canGet();a&&console.log("ok dans l'inventaire, enfin presque...")},this.canGet=function(){var a=12,b=-Math.sin(this.corps.rotation.y),d=-Math.cos(this.corps.rotation.y),e=new THREE.Raycaster(this.corps.position,new THREE.Vector3(b*a,0,d*a).normalize()),f=e.intersectObjects(D);if(f.length>0&&f[0].distance<a){s.remove(f[0].object);for(var g in D)D[g].id==f[0].object.id&&(c.remove(D[g].position.x,D[g].position.y,D[g].position.z),D.splice(g,1));return!0}return!1},this.putCube=function(){if(B[10].mesh.visible){var a=new THREE.Mesh(u,C);a.position.x=Math.round(B[10].mesh.position.x/z)*z,a.position.y=Math.round(B[10].mesh.position.y/z)*z,a.position.z=Math.round(B[10].mesh.position.z/z)*z,s.add(a),D.push(a),B[10].mesh.visible=!1,c.put(a.position.x,a.position.y,a.position.z,y)}else B[10].mesh.visible=!0},this.canPut=function(){var a=12;if(-Math.sin(this.corps.rotation.y),-Math.cos(this.corps.rotation.y),intersects.length>0&&intersects[0].distance<a){s.remove(intersects[0].object);for(var b in D)D[b].id==intersects[0].object.id&&D.splice(b,1);return!0}return!1},this.setCamDist=function(a){A=a,this.camera.position.x=this.tete.position.x+Math.sin(this.tete.rotation.y)*A,this.camera.position.z=this.tete.position.z+Math.cos(this.tete.rotation.y)*A},this.camdist=function(a){A-=a/30,0>A&&(A=0),A>200&&(A=200),this.setCamDist(A)},this.setCamDist(40)}function n(a,b,c,f){this.id=a,this.name=b,this.corps=new THREE.Object3D,d(this.corps.position,c);var g=new THREE.CubeGeometry(z/2,z/2,z/2),h=new THREE.MeshLambertMaterial({color:16776960});this.torse=new THREE.Mesh(g,h),this.corps.add(this.torse);var i=new THREE.CubeGeometry(z/4,z/4,z/4);this.tete=new THREE.Mesh(i,h),this.tete.position.y=z/2,this.corps.add(this.tete);var j=new THREE.TextGeometry(b,{font:"optimer",weight:"normal",style:"normal",size:2,height:.5,bevelThickness:.1,bevelSize:.1,bevelEnabled:!0}),k=new THREE.MeshPhongMaterial({color:16755200});return this.name_label=new THREE.Mesh(j,k),this.name_label.position.y=.1*z,this.name_label.position.z=.25*z,this.name_label.position.x=-5,this.corps.add(this.name_label),e(this,f),s.add(this.corps),D.push(this.torse),this.move=function(a,b){d(this.corps.position,a),e(this,b)},this}function o(){this.mesh=new THREE.BoxHelper,this.mesh.material.color.setRGB(0,1,0),this.mesh.scale.set(10,10,10),this.mesh.position.y=20,this.mesh.position.x=15,this.mesh.visible=!1}function p(a){switch(a.button){case 0:v.getCube();break;case 1:break;case 2:v.putCube()}}var q=new THREEx.RendererStats;q.domElement.style.position="absolute",q.domElement.style.left="0px",q.domElement.style.bottom="0px",document.body.appendChild(q.domElement);var r,s,t,u,v,w,x,y=1,l=!1,z=20,A=(Date.now(),0),B=[],u=new THREE.CubeGeometry(z,z,z),C=new THREE.MeshLambertMaterial({map:THREE.ImageUtils.loadTexture("images/boite.jpg")}),D=(new THREE.Vector3,[]),E=Math.PI;return{init:function(a){f(a)},animate:function(){j()},addMainPlayer:function(a,b){return new m(a,b)},addPNJ:function(a,b,c,d){return new n(a,b,c,d)}}}]);