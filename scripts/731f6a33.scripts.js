"use strict";angular.module("gameApp",["ngCookies","ngResource","ngSanitize","gameApp.services.db","gameApp.services.game"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/game",{templateUrl:"views/game.html",controller:"GameCtrl"}).when("/users",{templateUrl:"views/users.html",controller:"UsersCtrl"}).when("/about",{templateUrl:"views/about.html"}).otherwise({redirectTo:"/"})}]),angular.module("gameApp").controller("MainCtrl",["$scope","Db","Game",function(a,b){function c(b){var c=null;return a.users.some(function(a){return a.name==b?(c=a,void 0):void 0}),c}var d="";a.changeLogin=function(){var d=c(a.name);d?b.setUser(d):console.log("ooops this user does not exists")},a.signup=function(){if(a.error="",!a.users)return a.error="waiting for users to load",void 0;var e=c(a.name);if(e)return writeCookie("jetname",a.name,20),a.error="",d=a.name,void 0;if(e)a.error="pseudo "+a.name+" is already taken",a.name="";else{var f=a.email;f||(f=""),b.addUser(a.name,f),a.pwd="enregistr√©!",$("#msg").focus(),writeCookie("jetname",a.name,20),a.error="",d=a.name}},d=readCookie("jetname"),a.name=d,a.isSignedIn=function(){return""!=d},b.init(),b.getUsers(function(d){a.users=[];for(var e in d)a.users.push(b.newUser(e,d[e].name,d[e].email,d[e].pos,d[e].rot));var f=c(a.name);f.pos||(f.pos={x:0,y:0,z:0}),f.rot||(f.rot={corps:0,tete:0}),console.log(f),b.setUser(f),console.log(a.users.length+" users")}),b.getTchat(function(a,b){$("<div/>").text(b).prepend($("<em/>").text(a+": ")).appendTo($("#messagesDiv")),$("#messagesDiv")[0].scrollTop=$("#messagesDiv")[0].scrollHeight}),a.addMsg=function(c,d){b.addMessage(c,d),a.msg=""}}]),angular.module("gameApp").controller("GameCtrl",["$scope","$timeout","$location","Db","Game",function(a,b,c,d,e){function f(a){var b=null;return i.some(function(c){return c.id==a?(b=c,void 0):void 0}),b}function g(a,b){var c=f(a);c?c.move(b.pos,b.rot):console.log("player "+a+" not found")}var h=d.getUser();if(!h)return c.path("/"),void 0;var i=[];d.getUsers(function(b){var c=e.addMainPlayer(h.name,h.pos);e.init(c),a.players=[];for(var f in b){b[f].pos||(b[f].pos={x:0,y:0,z:0}),b[f].rot||(b[f].rot={corps:0,tete:0});var c=d.newPlayer(f,b[f].name,b[f].pos,b[f].rot,g);c.id!=h.id&&i.push(e.addPNJ(c.id,c.name,c.pos,c.rot))}console.log(i.length+" pnjs"),e.animate(),$("#instructions").click(function(){enablePointerLock()})})}]),angular.module("gameApp").controller("UsersCtrl",["$scope","Db",function(a,b){b.init(),b.getUsers(function(c){a.users=[];for(var d in c)a.users.push(b.newUser(d,c[d].name,c[d].email));console.log(a.users.length+" users")}),a.addUser=function(a){b.addUser(a,"no email")}}]),angular.module("gameApp").controller("HeaderCtrl",["$scope","$location",function(a,b){a.isActive=function(a){return a===b.path()}}]),angular.module("gameApp.services.db",[]).factory("Db",["$rootScope","$location",function(a){function b(a,b){a.$$phase||a.$root.$$phase?b():a.$apply(b)}var c,d,e,f={firebaseUrl:"https://voxelgame.firebaseio.com"};return{init:function(){c=new Firebase(f.firebaseUrl+"/users"),e=new Firebase(f.firebaseUrl+"/tchat"),console.log("db users ref: "+c)},setUser:function(a){d=a,console.log("connection: "+a.name+", "+a.id)},getUsers:function(d){return c?(c.once("value",function(c){null!==c.val()?b(a,function(){d(c.val())}):console.log("no values in DB")}),void 0):(console.log("no users ref while getting values"),void 0)},getUser:function(){return d},addUser:function(a,b){c.push({name:a,email:b})},newUser:function(a,b,c,d,e){return{id:a,name:b,email:c,pos:d,rot:e}},newPlayer:function(c,e,g,h,i){if(c!=d.id){var j=new Firebase(f.firebaseUrl+"/users/"+c);j.on("value",function(d){b(a,function(){i(c,d.val())})})}return{id:c,name:e,pos:g,rot:h}},addMessage:function(a,b){e.push({name:a,text:b})},getTchat:function(a){e.on("child_added",function(b){var c=b.val();a(c.name,c.text)})},updatePos:function(a){d&&c.child(d.id).child("pos").update(a)},updateRot:function(a){d&&c.child(d.id).child("rot").update(a)}}}]),angular.module("gameApp.services.game",[]).factory("Game",["$rootScope","$location","Db",function(a,b,c){function d(a,b){a.x=b.x,a.y=b.y,a.z=b.z}function e(a,b){a.corps.rotation.y=b.corps,a.tete.rotation.x=b.tete}function f(a){u=a,r=new THREE.Scene,r.fog=new THREE.Fog(17476,0,200),v=new THREE.DirectionalLight(17476,1.5),v.position.set(1,1,1),r.add(v),v=new THREE.DirectionalLight(16776960,1.5),v.position.set(-1,-1,-1),r.add(v),w=new THREE.PointLight(16777215,2,50),w.position.set(-1,1,-1),r.add(w),r.add(u.corps),l&&l();for(var b=-x[2]/2;b<x[2]/2;b++)for(var c=-x[0]/2;c<x[0]/2;c++)new o({x:c*y,y:0,z:b*y});for(var b=4*-x[2];b<4*x[2];b++)for(var c=4*-x[0];c<4*x[0];c++)(c>2*x[0]||c<2*-x[0])&&new o({x:c*y,y:-y,z:b*y});for(var d=0;500>d;d++)new o({x:k(y/2),y:k(),z:k(y/2)});s=new THREE.WebGLRenderer,s.setClearColor(17476),q=$("#game"),g(),q.append(s.domElement),window.addEventListener("resize",g,!1),h()}function g(){u.camera.aspect=window.innerWidth/window.innerHeight,u.camera.updateProjectionMatrix();var a=window.innerWidth-2*q[0].offsetLeft,b=window.innerHeight-2*q[0].offsetTop;s.setSize(a,b),q[0].style.width=a,q[0].style.height=b}function h(){var a=function(a){var b=a.movementX||a.mozMovementX||a.webkitMovementX||0,d=a.movementY||a.mozMovementY||a.webkitMovementY||0;u.corps.rotation.y-=.002*b,u.tete.rotation.x-=.002*d,c.updateRot({corps:u.corps.rotation.y,tete:u.tete.rotation.x})},b=function(a){switch(a.keyCode){case 90:u.moveForward=!0;break;case 81:u.moveLeft=!0;break;case 83:u.moveBackward=!0;break;case 68:u.moveRight=!0;break;case 32:u.jumping=!0,u.jump();break;case 69:u.getCube();break;case 82:u.putCube()}},d=function(a){switch(a.keyCode){case 38:case 87:case 90:u.moveForward=!1;break;case 37:case 65:case 81:u.moveLeft=!1;break;case 40:case 83:u.moveBackward=!1;break;case 39:case 68:u.moveRight=!1}};document.addEventListener("mousemove",a,!1),document.addEventListener("keydown",b,!1),document.addEventListener("keyup",d,!1),document.addEventListener("mousewheel",function(a){return u.camdist(a),!1},!1)}function i(){requestAnimationFrame(i),u&&(isLocked&&(u.move(),u.jump(),w.position.set(u.corps.position.x,u.corps.position.y+y,u.corps.position.z)),s.render(r,u.camera),u.corps.position.y>250&&j())}function j(){$("#instructions").html("Bravo!! -> F5 :)"),$("#blocker").show()}function k(a){return a="undefined"!=typeof a?a:0,Math.floor(Math.random()*y-a)*y}function l(){A[0]=new p,r.add(A[0].mesh),A[1]=new p,r.add(A[1].mesh),A[2]=new p,r.add(A[2].mesh)}function m(a,b){var d=8,e=document.createElement("audio"),f=document.createElement("source");f.src="sounds/ammo_bounce.wav",e.appendChild(f),e.play();var g=!0,h=0,i=new THREE.Vector3(b.x,b.y,b.z);this.name=a,this.jumping=!1,this.corps=new THREE.Object3D,this.corps.position.y=y;var j=THREE.ImageUtils.loadTexture("images/ash_uvgrid01.jpg");j.wrapS=j.wrapT=THREE.RepeatWrapping,j.anisotropy=16;var k=new THREE.MeshLambertMaterial({ambient:12303291,map:j}),m=new THREE.CubeGeometry(y/2,y/2,y/2);this.torse=new THREE.Mesh(m,k),this.corps.add(this.torse);var n=new THREE.CubeGeometry(y/4,y/4,y/4);this.tete=new THREE.Mesh(n,k),this.tete.position.y=y/2,this.corps.add(this.tete),this.camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1e3),this.camera.position.x+=Math.sin(this.corps.rotation.y)*z,this.camera.position.z+=Math.cos(this.corps.rotation.y)*z,this.tete.add(this.camera),this.move=function(){i.copy(this.corps.position);var a=this.canMove();a&&(i.x+=a[0],i.z+=a[1],this.corps.position.copy(i),c.updatePos({x:i.x,y:i.y,z:i.z}))},this.canMove=function(){var a=[],b=[],c=C/4;a[0]=0,b[0]=0,a[1]=0,b[1]=0,a[2]=0,b[2]=0,this.moveForward&&(a[0]-=Math.sin(this.corps.rotation.y-c),b[0]-=Math.cos(this.corps.rotation.y-c),a[1]-=Math.sin(this.corps.rotation.y),b[1]-=Math.cos(this.corps.rotation.y),a[2]-=Math.sin(this.corps.rotation.y+c),b[2]-=Math.cos(this.corps.rotation.y+c)),this.moveBackward&&(a[0]+=Math.sin(this.corps.rotation.y-c),b[0]+=Math.cos(this.corps.rotation.y-c),a[1]+=Math.sin(this.corps.rotation.y),b[1]+=Math.cos(this.corps.rotation.y),a[2]+=Math.sin(this.corps.rotation.y+c),b[2]+=Math.cos(this.corps.rotation.y+c)),this.moveLeft&&(a[0]-=Math.sin(this.corps.rotation.y+C/2-c),b[0]-=Math.cos(this.corps.rotation.y+C/2-c),a[1]-=Math.sin(this.corps.rotation.y+C/2),b[1]-=Math.cos(this.corps.rotation.y+C/2),a[2]-=Math.sin(this.corps.rotation.y+C/2+c),b[2]-=Math.cos(this.corps.rotation.y+C/2+c)),this.moveRight&&(a[0]-=Math.sin(this.corps.rotation.y-C/2-c),b[0]-=Math.cos(this.corps.rotation.y-C/2-c),a[1]-=Math.sin(this.corps.rotation.y-C/2),b[1]-=Math.cos(this.corps.rotation.y-C/2),a[2]-=Math.sin(this.corps.rotation.y-C/2+c),b[2]-=Math.cos(this.corps.rotation.y-C/2+c));for(var f=[a[1],b[1]],g=0;3>g;g++){var h=new THREE.Raycaster(this.corps.position,new THREE.Vector3(a[g]*d,0,b[g]*d).normalize()),i=h.intersectObjects(B);i.length>0&&i[0].distance<d&&(e.play(),f=!1),l&&(A[g].mesh.position.y=this.corps.position.y,A[g].mesh.position.x=this.corps.position.x+a[g]*d,A[g].mesh.position.z=this.corps.position.z+b[g]*d)}return f},this.jump=function(){g&&1==this.jumping&&(g=!1,h=4);var a=!0,b=new THREE.Raycaster(this.corps.position,new THREE.Vector3(0,-1,0)),c=b.intersectObjects(B);c.length>0&&c[0].distance<d&&(a=!1),0>h&&(this.jumping=!1),a||1==this.jumping?(h>-5&&(h-=.2),this.corps.position.y+=h):(0>h&&(h=0),g=!0,this.jumping=!1)},this.getCube=function(){canGet=this.canGet(),canGet&&console.log("ok dans l'inventaire, enfin presque...")},this.canGet=function(){var a=12;deltaX=-Math.sin(this.corps.rotation.y),deltaZ=-Math.cos(this.corps.rotation.y);var b=new THREE.Raycaster(this.corps.position,new THREE.Vector3(deltaX*a,0,deltaZ*a).normalize()),c=b.intersectObjects(B);if(c.length>0&&c[0].distance<a){r.remove(c[0].object);for(var d in B)B[d].id==c[0].object.id&&B.splice(d,1);return!0}return!1},this.putCube=function(){t=new THREE.CubeGeometry(y,y,y);var a=new THREE.MeshLambertMaterial({map:THREE.ImageUtils.loadTexture("images/boite.jpg")}),b=new THREE.Mesh(t,a);b.position.x=Math.round((this.corps.position.x-Math.sin(this.corps.rotation.y)*y)/y)*y,b.position.z=Math.round((this.corps.position.z-Math.cos(this.corps.rotation.y)*y)/y)*y,b.position.y=Math.round(this.corps.position.y/y)*y,r.add(b),B.push(b)},this.canPut=function(){var a=12;if(deltaX=-Math.sin(this.corps.rotation.y),deltaZ=-Math.cos(this.corps.rotation.y),intersects.length>0&&intersects[0].distance<a){r.remove(intersects[0].object);for(var b in B)B[b].id==intersects[0].object.id&&B.splice(b,1);return!0}return!1},this.camdist=function(a){z-=a.wheelDelta/60,0>z&&(z=0),z>100&&(z=100),this.camera.position.x=this.tete.position.x+Math.sin(this.tete.rotation.y)*z,this.camera.position.z=this.tete.position.z+Math.cos(this.tete.rotation.y)*z}}function n(a,b,c,f){this.id=a,this.name=b,this.corps=new THREE.Object3D,d(this.corps.position,c);var g=new THREE.CubeGeometry(y/2,y/2,y/2),h=new THREE.MeshLambertMaterial({color:16776960});this.torse=new THREE.Mesh(g,h),this.corps.add(this.torse);var i=new THREE.CubeGeometry(y/4,y/4,y/4);return this.tete=new THREE.Mesh(i,h),this.tete.position.y=y/2,this.corps.add(this.tete),e(this,f),this.move=function(a,b){d(this.corps.position,a),e(this,b)},this}function o(a){var b=new THREE.CubeGeometry(y,y,y),c=new THREE.MeshLambertMaterial({map:THREE.ImageUtils.loadTexture("images/boite.jpg")}),d=new THREE.Mesh(b,c);d.position.copy(a),r.add(d),B.push(d)}function p(){var a=new THREE.CubeGeometry(1,1,1),b=new THREE.MeshLambertMaterial({color:16777215*Math.random()});this.mesh=new THREE.Mesh(a,b),this.mesh.position.y=20,this.mesh.position.x=15,this.get=function(){console.log("get")}}var q,r,s,t,u,v,w,l=!1,x=[6,20,6],y=20,z=(Date.now(),0),A=[],B=(new THREE.Vector3,[]),C=Math.PI;return{init:function(a){f(a)},animate:function(){i()},addMainPlayer:function(a,b){var c=new m(a,b);return r&&r.add(c.corps),c},addPNJ:function(a,b,c,d){var e=new n(a,b,c,d);return r.add(e.corps),B.push(e.torse),e}}}]);